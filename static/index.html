<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Clinote">
<meta name="theme-color" content="#ffffff">
<link rel="manifest" href="/static/manifest.json">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
<title>Clinote</title>
<style>
/* â•â• Theme variables â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --red: #ef4444;
  --yellow: #f59e0b;
  --radius: 8px;
  --accent: #111111;
  --accent2: #333333;
  --bg: #f8f9fa;
  --card: #ffffff;
  --card2: #f5f6f7;
  --border: #e8e9eb;
  --text: #111111;
  --text2: #8a8a8a;
  --shadow: 0 1px 8px rgba(0,0,0,0.06);
  --chip-bg: #f0f0f0;
  --chip-text: #333333;
}

/* â•â• Reset & Base â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
body {
  background: #0d0d0d;
  font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  min-height: 100dvh;
  display: flex;
  justify-content: center;
  letter-spacing: -0.2px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
#app {
  width: 100%; max-width: 480px;
  min-height: 100dvh;
  display: flex; flex-direction: column;
  background: var(--bg);
  color: var(--text);
  transition: background 0.2s, color 0.2s;
  position: relative;
}
.screen { display: none; flex: 1; flex-direction: column; padding-bottom: 80px; }
.screen.active { display: flex; }

/* â•â• Header â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  background: #ffffff;
  position: sticky; top: 0; z-index: 10;
  transition: background 0.2s, border-color 0.2s;
}
.header h1 { font-size: 18px; font-weight: 800; color: var(--text); letter-spacing: -0.5px; flex-shrink: 0; line-height: 1.3; }
.header-logo { height: 20px; width: auto; flex: none; }
.header-spacer { flex: 1; }
.header .subtitle { font-size: 13px; color: var(--text2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; letter-spacing: -0.2px; }

/* â•â• Logout button â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.logout-btn {
  background: none;
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 6px 14px;
  font-size: 13px; font-weight: 600;
  color: var(--text2);
  cursor: pointer;
  flex-shrink: 0;
  font-family: inherit;
}
.logout-btn:active { opacity: 0.6; }

/* â•â• Bottom Nav â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  width: 100%;
  max-width: 480px;
  margin: 0 auto;
  background: #ffffff;
  border-top: 1px solid var(--border);
  padding: 8px 0 max(8px, env(safe-area-inset-bottom));
  transition: background 0.2s, border-color 0.2s;
  z-index: 100;
}
.bottom-nav.visible { display: flex; }
.nav-btn {
  flex: 1;
  display: flex; flex-direction: column; align-items: center; gap: 1px;
  background: none; border: none; cursor: pointer;
  color: var(--text2); font-size: 10px; padding: 8px 0;
  transition: color 0.15s;
  font-weight: 500;
  letter-spacing: -0.1px;
}
.nav-btn svg { width: 20px; height: 20px; stroke-width: 0.833333; }
.nav-btn.active { color: var(--text); font-weight: 600; }

/* â•â• Scroll area & Scrollbar â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.scroll-area { flex: 1; overflow-y: auto; padding: 20px; }
#history-list.scroll-area,
#screen-template .scroll-area { padding: 0 20px 20px 20px; }

/* Custom Scrollbar */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--text2);
}

/* â•â• Forms â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
label {
  display: block; font-size: 13px; color: var(--text2);
  margin-bottom: 6px; font-weight: 500;
  letter-spacing: -0.2px;
}
input, textarea, select {
  width: 100%;
  background: #ffffff;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-size: 14px;
  padding: 11px 14px;
  font-family: inherit;
  outline: none;
  transition: all 0.15s;
  letter-spacing: -0.2px;
}
input:focus, textarea:focus, select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(17, 17, 17, 0.08);
}
input::placeholder, textarea::placeholder {
  color: rgba(17, 17, 17, 0.4);
}
select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23111111' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
textarea { resize: vertical; min-height: 80px; line-height: 1.6; }
.form-group { margin-bottom: 20px; }

/* â•â• Buttons â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 14px 18px; border-radius: var(--radius); border: none;
  font-size: 15px; font-weight: 600; cursor: pointer;
  transition: all 0.15s;
  font-family: inherit; letter-spacing: -0.3px;
}
.btn:active { opacity: 0.6; }
.btn-primary { background: var(--accent); color: #fff; width: 100%; height: 52px; }
.btn-primary:hover { opacity: 0.9; }
#generate-btn, #tmpl-generate-btn {
  display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 8px;
  width: 100%; height: 52px; padding: 0 18px; border-radius: var(--radius); border: none;
  background: var(--accent); color: #fff; font-size: 15px; font-weight: 600;
  cursor: pointer; font-family: inherit; letter-spacing: -0.3px;
  transition: all 0.15s;
}
#generate-btn:disabled, #tmpl-generate-btn:disabled { opacity: 0.6; cursor: not-allowed; }
#generate-btn:not(:disabled):hover, #tmpl-generate-btn:not(:disabled):hover { opacity: 0.9; }
#generate-btn:not(:disabled):active, #tmpl-generate-btn:not(:disabled):active { opacity: 0.6; }
.btn-secondary { background: #ffffff; color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--card2); }
.btn-danger { background: var(--red); color: #fff; }
.btn-sm { padding: 8px 16px; font-size: 13px; white-space: nowrap; height: 36px; font-weight: 500; letter-spacing: -0.2px; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }

/* â•â• Chips (predefined options) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chip-label {
  font-size: 13px; color: var(--text2);
  font-weight: 500; letter-spacing: -0.2px;
  margin-bottom: 8px; margin-top: 4px;
}
.chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
.chip {
  padding: 8px 12px; border-radius: 20px; font-size: 12px;
  background: var(--card2); border: 1px solid var(--border);
  cursor: pointer; transition: all 0.15s;
  color: var(--text2); font-weight: 500; line-height: 1;
  user-select: none; height: 32px; display: inline-flex; align-items: center;
  letter-spacing: -0.1px;
}
.chip:hover { background: #ececec; }
.chip:active { opacity: 0.6; }
.chip.selected { background: var(--accent); color: #fff; border-color: var(--accent); }
.chip-section-title { font-size: 13px; color: var(--text2); margin: 12px 0 8px; font-weight: 600; width: 100%; }

/* â•â• Tags (added items) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tags-wrap { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; min-height: 8px; }
.tag {
  display: flex; align-items: center; gap: 4px;
  background: var(--card2); border: 1px solid var(--border);
  border-radius: 20px; padding: 4px 10px; font-size: 13px; color: var(--text);
}
.tag-remove { background: none; border: none; color: var(--text2); cursor: pointer; font-size: 16px; line-height: 1; padding: 0 2px; opacity: 0.7; }
.add-tag-row { display: flex; gap: 8px; margin-top: 8px; }
.add-tag-row input { flex: 1; }

/* Forbidden tags (different color) */
.forbidden-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.ftag {
  display: flex; align-items: center; gap: 4px;
  background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
  border-radius: 20px; padding: 4px 10px; font-size: 13px; color: var(--red);
}
.ftag-remove { background: none; border: none; color: var(--red); cursor: pointer; font-size: 16px; line-height: 1; padding: 0 2px; opacity: 0.7; }

/* â•â• Stars â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stars { display: flex; gap: 6px; }
.star-btn { background: none; border: none; cursor: pointer; font-size: 26px; color: var(--border); transition: color 0.1s; line-height: 1; }
.star-btn.active { color: var(--yellow); }

/* â•â• Platform tabs â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.platform-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
.platform-tab {
  flex: 1; padding: 0; height: 36px; border-radius: var(--radius); border: 1px solid var(--border);
  background: #ffffff; color: var(--text2); font-size: 13px; font-weight: 500;
  cursor: pointer; text-align: center; transition: all 0.15s;
  display: inline-flex; align-items: center; justify-content: center;
  letter-spacing: -0.2px;
}
.platform-tab:hover { background: var(--card2); }
.platform-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 600; }

/* â•â• Reply output â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.reply-output {
  background: var(--card2);
  border: none;
  border-radius: var(--radius);
  padding: 14px;
  font-size: 14px; line-height: 1.6;
  min-height: 120px;
  white-space: pre-wrap; word-break: break-word;
  transition: background 0.2s;
  letter-spacing: -0.2px;
  color: var(--text);
}
.reply-output.empty { color: var(--text2); font-style: normal; display: flex; align-items: center; justify-content: center; }
.copy-row { display: flex; gap: 8px; margin-top: 16px; }
.copy-row .btn { flex: 1; white-space: nowrap; }

/* â•â• Input card (Threads style) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.input-card {
  background: #ffffff; border: 1px solid var(--border);
  border-radius: 12px; padding: 20px; margin-bottom: 16px;
}
.input-card-label {
  font-size: 14px; font-weight: 600; color: var(--text);
  margin-bottom: 8px; letter-spacing: -0.2px;
}
.input-card textarea, .input-card input {
  border: none; background: transparent; padding: 0;
  font-size: 14px; letter-spacing: -0.2px; line-height: 1.6;
}
.input-card textarea:focus, .input-card input:focus { border: none; box-shadow: none; outline: none; }
.input-card .reply-output {
  background: transparent; border: none; padding: 0;
  border-radius: 0; min-height: 80px;
}

/* â•â• History â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.history-card {
  background: #ffffff; border: 1px solid var(--border);
  border-radius: 12px; padding: 16px; margin-bottom: 12px;
  transition: all 0.15s;
}
.history-card:hover { box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04); }
.history-card .meta { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
.platform-badge {
  font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 20px;
  background: #e0f2fe; color: #0369a1;
  letter-spacing: -0.1px;
}
.rating-stars { color: var(--yellow); font-size: 13px; }
.history-date { font-size: 12px; color: var(--text2); margin-left: auto; letter-spacing: -0.2px; }
.history-review { font-size: 13px; color: var(--text2); margin-bottom: 8px; padding-left: 0; line-height: 1.6; letter-spacing: -0.2px; }
.history-reply { font-size: 14px; line-height: 1.6; color: var(--text); letter-spacing: -0.2px; }
.history-actions { display: flex; gap: 8px; margin-top: 12px; justify-content: flex-start; }

/* â•â• Char count â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.char-count { font-size: 12px; color: var(--text2); text-align: right; margin-top: 6px; letter-spacing: -0.2px; }
.char-count.warn { color: var(--yellow); }

/* â•â• Login â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.login-wrap {
  display: flex; flex-direction: column; align-items: center;
  flex: 1; padding-bottom: max(32px, env(safe-area-inset-bottom));
  background: var(--bg);
}
.login-hero {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  text-align: center; padding: 0 20px;
}
.login-logo { height: 48px; width: auto; margin-bottom: 24px; display: block; }
.login-tagline { font-size: 14px; color: var(--text2); line-height: 1.6; font-weight: 400; letter-spacing: -0.2px; }
.login-bottom { width: 100%; padding: 0 20px; display: flex; flex-direction: column; align-items: center; max-width: 400px; }

/* â•â• Back / Gear buttons â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.back-btn {
  background: none; border: none; cursor: pointer;
  color: var(--text); padding: 8px; margin-right: 4px;
  display: flex; align-items: center; flex-shrink: 0;
}
.back-btn:active { opacity: 0.6; }
.gear-btn {
  background: none; border: none; cursor: pointer;
  color: var(--text2); padding: 8px; flex-shrink: 0;
  display: flex; align-items: center;
}
.gear-btn svg { width: 20px; height: 20px; stroke-width: 0.833333; }
.gear-btn:hover { color: var(--text); }
.gear-btn:active { opacity: 0.6; }
#trial-badge {
  display: none; align-items: center; gap: 4px;
  border: none; border-radius: 20px; cursor: pointer;
  padding: 4px 10px; margin-right: 8px; flex-shrink: 0;
  font-size: 11px; font-weight: 700; line-height: 1;
  background: linear-gradient(135deg, var(--yellow) 0%, #f59e0b 100%);
  color: #ffffff;
  letter-spacing: -0.1px;
}
#trial-badge svg { width: 13px; height: 13px; }
#trial-badge.danger {
  background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  color: #ffffff;
}

/* â•â• Env settings screen â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.env-profile-section {
  display: flex; flex-direction: column; align-items: center;
  padding: 32px 20px 24px; gap: 12px;
  background: #ffffff;
  border-bottom: 1px solid var(--border);
}
.env-avatar {
  width: 80px; height: 80px; border-radius: 50%;
  background: var(--card2); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px; overflow: hidden; flex-shrink: 0;
}
.env-nickname { font-size: 18px; font-weight: 700; color: var(--text); letter-spacing: -0.3px; }
.env-subtitle { font-size: 13px; color: var(--text2); letter-spacing: -0.2px; }
.env-section-label {
  font-size: 12px; font-weight: 700; color: var(--text2);
  letter-spacing: -0.2px;
  padding: 0; margin: 20px 0 12px;
}
.env-list-card {
  background: #ffffff; border: 1px solid var(--border);
  border-radius: 12px; overflow: hidden;
}
.env-list-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px; font-size: 14px; color: var(--text);
  background: #ffffff; gap: 12px;
  transition: background 0.15s;
  cursor: pointer;
  letter-spacing: -0.2px;
}
.env-list-row:hover { background: var(--card2); }
.env-list-row:not(:last-child) { border-bottom: 1px solid var(--border); }
.env-list-row label {
  font-size: 14px; color: var(--text); font-weight: 400;
  margin: 0; flex: 1;
  letter-spacing: -0.2px;
  cursor: pointer;
}
.env-list-row select {
  border: none; background: transparent; font-size: 14px;
  color: var(--text2); text-align: right; padding: 0;
  font-family: inherit; cursor: pointer; max-width: 120px;
  -webkit-appearance: none;
  letter-spacing: -0.2px;
}
.env-list-row.destructive { color: var(--red); }
.env-list-row.destructive label { color: var(--red); }
.env-list-row.destructive:hover { background: rgba(239, 68, 68, 0.05); }
.env-row-value { font-size: 14px; color: var(--text2); letter-spacing: -0.2px; }
.env-info-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 14px 0; font-size: 15px;
}
.error-msg { color: var(--red); font-size: 13px; margin-top: 10px; min-height: 20px; }
.notice-item { padding: 16px 0; border-bottom: 1px solid var(--border); }
.notice-item:last-child { border-bottom: none; }
.notice-date { font-size: 11px; color: var(--text2); margin-bottom: 4px; letter-spacing: -0.1px; }
.notice-title { font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 8px; letter-spacing: -0.3px; }
.notice-body { font-size: 14px; color: var(--text2); line-height: 1.65; letter-spacing: -0.2px; }
.kakao-login-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%;
  background: #FEE500; color: #191919;
  border: none; border-radius: var(--radius);
  padding: 0; height: 52px; font-size: 15px; font-weight: 600;
  cursor: pointer; font-family: inherit;
  transition: all 0.15s;
  letter-spacing: -0.3px;
}
.kakao-login-btn:hover { opacity: 0.9; }
.kakao-login-btn:active { opacity: 0.6; }

/* â•â• Spinner â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.25); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; vertical-align: middle; flex-shrink: 0; }
.spinner-row { display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â• Toast â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: var(--text); color: var(--bg); padding: 10px 20px; border-radius: 20px;
  font-size: 14px; font-weight: 600; opacity: 0; transition: all 0.25s; pointer-events: none;
  white-space: nowrap; z-index: 9999;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â•â• Section title â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.section-title { font-size: 14px; color: var(--text); font-weight: 700; margin-bottom: 12px; margin-top: 0; letter-spacing: -0.2px; }
.settings-header { font-size: 13px; color: var(--text2); margin-bottom: 24px; line-height: 1.6; letter-spacing: -0.2px; }
.empty-state { text-align: center; color: var(--text2); padding: 64px 20px; font-size: 14px; letter-spacing: -0.2px; }
.empty-state .emoji { font-size: 48px; margin-bottom: 16px; }
.divider { height: 1px; background: var(--border); margin: 24px 0; }

/* â•â• Template grid â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tmpl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
.tmpl-card {
  background: #ffffff; border: 1px solid var(--border);
  border-radius: 12px; padding: 20px 16px;
  cursor: pointer; text-align: center; transition: all 0.15s;
}
.tmpl-card:hover { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); }
.tmpl-card:active { opacity: 0.6; }
.tmpl-card.selected { border-color: var(--accent); background: #ffffff; box-shadow: 0 0 0 2px var(--accent); }
.tmpl-card .tmpl-icon { font-size: 32px; margin-bottom: 12px; }
.tmpl-card .tmpl-name { font-size: 13px; font-weight: 600; color: var(--text); line-height: 1.3; letter-spacing: -0.2px; }
.tmpl-card .tmpl-desc { font-size: 11px; color: var(--text2); margin-top: 4px; letter-spacing: -0.1px; }

#tmpl-params { display: none; }
#tmpl-params.visible { display: block; }

/* â•â• History filter tabs â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.filter-tabs {
  display: flex; gap: 8px; padding: 16px 20px;
}
.filter-tab {
  padding: 0 24px; height: 36px; border-radius: 20px; font-size: 13px; font-weight: 500;
  background: none; border: 1px solid var(--border); color: var(--text2);
  cursor: pointer; transition: all 0.15s;
  white-space: nowrap;
  flex-shrink: 0;
  display: inline-flex; align-items: center; justify-content: center;
  letter-spacing: -0.2px;
}
.filter-tab:hover { background: var(--card2); }
.filter-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 600; }

/* â•â• Promo Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#promo-modal {
  display: none; position: fixed; inset: 0; z-index: 2000;
  align-items: center; justify-content: center;
}
#promo-modal.show { display: flex; }
.promo-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.75); }
.promo-box {
  position: relative; max-width: 320px; width: 88%;
  border-radius: 16px; overflow: hidden; z-index: 1;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
.promo-close {
  position: absolute; top: 10px; right: 10px;
  background: rgba(0,0,0,0.55); color: #fff; border: none;
  border-radius: 50%; width: 30px; height: 30px;
  font-size: 15px; cursor: pointer; z-index: 2;
  display: flex; align-items: center; justify-content: center;
}
#promo-img { width: 100%; display: block; }
#promo-caption {
  display: none; background: #fff; color: #111;
  text-align: center; font-size: 13px; font-weight: 600;
  padding: 10px 16px; letter-spacing: -0.2px;
}
#promo-caption.show { display: block; }

.ufilter {
  padding: 0 16px; height: 32px; border-radius: 20px; border: 1px solid var(--border);
  background: #ffffff; color: var(--text2); font-size: 12px; font-weight: 500;
  cursor: pointer; white-space: nowrap;
  display: inline-flex; align-items: center; justify-content: center;
  transition: all 0.15s;
  letter-spacing: -0.1px;
}
.ufilter:hover { background: var(--card2); }
.ufilter.active { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 600; }

/* â•â• Admin â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-admin { background: var(--bg); }
.admin-header {
  padding: 16px 20px 14px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px; background: var(--bg);
  position: sticky; top: 0; z-index: 10;
}
.admin-header h1 { font-size: 17px; font-weight: 800; flex: 1; letter-spacing: -0.5px; }
.admin-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg); }
.admin-tab {
  flex: 1; padding: 12px 0; font-size: 13px; font-weight: 600;
  background: none; border: none; border-bottom: 2px solid transparent;
  color: var(--text2); cursor: pointer; transition: all 0.15s;
}
.admin-tab.active { color: var(--text); border-bottom-color: var(--accent); }
.admin-pane { display: none; padding: 20px; }
.admin-pane.active { display: block; }
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.stat-card {
  background: var(--card2); border-radius: var(--radius); padding: 16px;
  border: 1px solid var(--border);
}
.stat-card .stat-val { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
.stat-card .stat-label { font-size: 12px; color: var(--text2); margin-top: 4px; }
.user-row {
  background: var(--card2); border-radius: var(--radius); padding: 14px 16px;
  margin-bottom: 10px; border: 1px solid var(--border); cursor: pointer;
}
.user-row:active { opacity: 0.7; }
.user-row-top { display: flex; align-items: center; gap: 10px; }
.user-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; background: var(--border); flex-shrink: 0; }
.user-info { flex: 1; min-width: 0; }
.user-name { font-size: 14px; font-weight: 600; }
.user-meta { font-size: 11px; color: var(--text2); margin-top: 2px; }
.plan-badge {
  font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 20px;
  background: var(--chip-bg); color: var(--chip-text);
}
.plan-badge.pro { background: #111; color: #fff; }
.plan-badge.beta { background: #e8f4fd; color: #1a6fb5; }
.user-sub-form {
  display: none; margin-top: 12px; padding-top: 12px;
  border-top: 1px solid var(--border);
}
.user-sub-form.open { display: block; }
.admin-field { margin-bottom: 10px; }
.admin-field label { font-size: 12px; color: var(--text2); display: block; margin-bottom: 4px; }
.admin-field select, .admin-field input[type="text"], .admin-field textarea {
  width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border);
  background: var(--bg); color: var(--text); font-size: 13px; font-family: inherit;
  box-sizing: border-box;
}
.admin-toggle { display: flex; align-items: center; gap: 8px; font-size: 13px; }
.popup-preview { margin-top: 12px; border-radius: 12px; overflow: hidden; max-width: 200px; }
.popup-preview img { width: 100%; display: block; }

/* â•â• Responsive Utilities â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.desktop-only { display: none; }
.mobile-only { display: block; }

/* â•â• PC Desktop (>= 1024px) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (min-width: 1024px) {
  /* Utilities */
  .desktop-only { display: block; }
  .mobile-only { display: none; }

  /* App container */
  body { background: var(--bg); }
  #app {
    max-width: 100%;
    flex-direction: row;
  }

  /* Sidebar */
  .sidebar {
    display: flex !important;
    flex-direction: column;
    width: 240px;
    background: #ffffff;
    border-right: 1px solid var(--border);
    position: sticky;
    top: 0;
    height: 100vh;
    flex-shrink: 0;
  }

  .sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: flex-start;
    height: 73px;
  }

  .sidebar-logo {
    width: auto !important;
    height: 32px !important;
  }

  .sidebar-logo-text {
    font-size: 24px;
    font-weight: 800;
    letter-spacing: -0.6px;
    color: var(--text);
    margin: 0;
  }

  .sidebar-title {
    font-size: 20px;
    font-weight: 800;
    letter-spacing: -0.5px;
    color: var(--text);
  }

  .sidebar-nav {
    flex: 1;
    padding: 16px 0;
    overflow-y: auto;
  }

  .sidebar-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 12px 20px;
    border: none;
    background: none;
    border-radius: 0;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: var(--text2);
    transition: all 0.15s;
    margin-bottom: 0;
    text-align: left;
    letter-spacing: -0.2px;
  }

  .sidebar-btn svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    stroke-width: 0.833333;
  }

  .sidebar-btn:hover {
    background: transparent;
    color: var(--text);
  }

  .sidebar-btn.active {
    background: transparent;
    color: var(--text);
    font-weight: 600;
  }

  .sidebar-footer {
    padding: 0;
    border-top: 1px solid var(--border);
  }

  .sidebar-footer .sidebar-btn {
    font-weight: 500;
  }

  /* Main content area */
  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
  }

  /* Hide mobile navigation */
  .bottom-nav {
    display: none !important;
  }

  /* Hide mobile headers (sidebar replaces them) */
  .screen > .header {
    display: none;
  }

  /* Remove bottom padding on desktop */
  .screen {
    padding-bottom: 0;
  }

  /* 2-column layout for reply screen */
  .reply-2col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    padding: 24px;
  }

  .reply-panel {
    display: flex;
    flex-direction: column;
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    min-height: calc(100vh - 120px);
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border);
    background: #ffffff;
  }

  .panel-header h2 {
    font-size: 16px;
    font-weight: 700;
    letter-spacing: -0.3px;
  }

  .panel-actions {
    display: flex;
    gap: 8px;
  }

  .panel-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .panel-content textarea {
    flex: 1;
    resize: none;
    padding: 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.6;
    font-family: inherit;
    letter-spacing: -0.2px;
  }

  .panel-content textarea::placeholder {
    color: rgba(17, 17, 17, 0.5);
  }

  .panel-content .reply-output {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.6;
    background: var(--card2);
    overflow-y: auto;
    letter-spacing: -0.2px;
  }

  .panel-content .reply-output.empty {
    color: var(--text2);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Page header (PC) */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
  }

  .page-header h1 {
    font-size: 24px;
    font-weight: 800;
    letter-spacing: -0.6px;
    line-height: 1.3;
  }

  .page-actions {
    display: flex;
    gap: 8px;
  }

  /* Filter panel (PC) */
  .filter-panel {
    display: flex;
    gap: 12px;
    padding: 16px 32px;
    background: var(--card2);
    border-bottom: 1px solid var(--border);
    align-items: center;
  }

  .filter-panel input[type="text"] {
    flex: 1;
    max-width: 300px;
  }

  .filter-panel select {
    width: auto;
    min-width: 150px;
  }

  /* Data table */
  .data-table-container {
    padding: 24px 32px;
    overflow-x: auto;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .data-table thead {
    background: var(--card2);
    border-bottom: 2px solid var(--border);
  }

  .data-table th {
    padding: 14px 16px;
    text-align: left;
    font-size: 13px;
    font-weight: 700;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .data-table td {
    padding: 16px;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    vertical-align: top;
  }

  .data-table td button {
    margin-bottom: 6px;
  }

  .data-table td button:last-child {
    margin-bottom: 0;
  }

  .data-table tbody tr:hover {
    background: var(--card2);
  }

  .data-table tbody tr:last-child td {
    border-bottom: none;
  }

  /* Type badge */
  .type-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .type-badge.review {
    background: #e0f2fe;
    color: #0369a1;
  }

  .type-badge.template {
    background: #fef3c7;
    color: #92400e;
  }

  /* 2-column layout */
  .desktop-2col {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 24px;
    padding: 24px 32px;
    min-height: calc(100vh - 140px);
  }

  /* Batch settings panel */
  .batch-settings {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    height: fit-content;
    position: sticky;
    top: 24px;
  }

  .batch-results {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    overflow-y: auto;
    max-height: calc(100vh - 180px);
  }

  /* CSV preview */
  .csv-preview {
    margin-top: 16px;
    padding: 16px;
    background: var(--card2);
    border-radius: var(--radius);
  }

  .csv-preview-table {
    overflow-x: auto;
    max-height: 200px;
    overflow-y: auto;
    margin: 12px 0;
  }

  .csv-preview-table .data-table {
    font-size: 12px;
  }

  .csv-info {
    font-size: 13px;
    color: var(--text2);
    margin-top: 8px;
  }
}
</style>
</head>
<body>
<div id="app">

<!-- â•â•â•â•â•â•â•â•â•â• SIDEBAR (PC only) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<aside class="sidebar" id="sidebar" style="display:none">
  <div class="sidebar-header">
    <h1 class="sidebar-logo-text">Clinote</h1>
  </div>
  <nav class="sidebar-nav">
    <button class="sidebar-btn" id="sidebar-reply" onclick="showScreen('reply')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
      <span>ë¦¬ë·° ë‹µë³€</span>
    </button>
    <button class="sidebar-btn" id="sidebar-template" onclick="showScreen('template')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <span>ë¬¸ìÂ·ê³µì§€</span>
    </button>
    <button class="sidebar-btn" id="sidebar-history" onclick="showScreen('history')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>
      <span>ì´ë ¥</span>
    </button>
    <button class="sidebar-btn" id="sidebar-clinic" onclick="showScreen('clinic')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
      <span>ë³‘ì›ì •ë³´</span>
    </button>
  </nav>
  <div class="sidebar-footer">
    <button class="sidebar-btn" onclick="showEnvSettings()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      <span>í™˜ê²½ì„¤ì •</span>
    </button>
  </div>
</aside>

<!-- â•â•â•â•â•â•â•â•â•â• PROMO MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="promo-modal">
  <div class="promo-backdrop" onclick="closePromo()"></div>
  <div class="promo-box">
    <button class="promo-close" onclick="closePromo()">âœ•</button>
    <a id="promo-link" href="#" target="_blank" rel="noopener">
      <img id="promo-img" src="" alt="ê³µì§€">
    </a>
    <div id="promo-caption"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main-content">

<!-- â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-login" class="screen active">
  <div class="login-wrap">
    <div class="login-hero">
      <img src="/static/logo.svg" alt="Clinote" class="login-logo">
      <div class="login-tagline">ë³‘ì› ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ì˜ AI ì‹¤ì¥</div>
    </div>
    <div class="login-bottom">
      <button class="kakao-login-btn" onclick="doKakaoLogin()">
        <svg width="22" height="22" viewBox="0 0 22 22" fill="none">
          <path d="M11 2C6.03 2 2 5.36 2 9.5c0 2.64 1.65 4.96 4.13 6.3l-1.05 3.87c-.09.34.28.6.57.4L10.1 17.7c.3.04.6.06.9.06 4.97 0 9-3.36 9-7.5S15.97 2 11 2z" fill="#191919"/>
        </svg>
        ì¹´ì¹´ì˜¤ë¡œ ë¡œê·¸ì¸
      </button>
      <div class="error-msg" id="login-error"></div>
      <p style="margin-top:16px;font-size:12px;color:var(--text2);text-align:center;line-height:1.6">
        ë¡œê·¸ì¸ ì‹œ
        <a href="/terms" target="_blank" style="color:var(--text2);text-decoration:underline">ì´ìš©ì•½ê´€</a>ê³¼
        <a href="/privacy" target="_blank" style="color:var(--text2);text-decoration:underline">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>ì—<br>ë™ì˜í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.
      </p>
      <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border);text-align:center;">
        <p style="font-size:11px;color:var(--text2);line-height:1.5;margin-bottom:4px;">
          <strong style="color:var(--text);">Clinote (ë¸”ë¦¬ì¹˜)</strong>
        </p>
        <p style="font-size:11px;color:var(--text2);line-height:1.5;">
          ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 123-45-03602 | ëŒ€í‘œ: ì´ë¯¼ê²½
        </p>
        <p style="font-size:11px;color:var(--text2);line-height:1.5;">
          ì´ë©”ì¼: designbleach@gmail.com
        </p>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• REPLY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-reply" class="screen">
  <div class="header">
    <img src="/static/logo.svg" alt="Clinote" class="header-logo">
    <span class="header-spacer"></span>
    <span class="subtitle" id="clinic-name-header"></span>
    <button id="trial-badge" onclick="showEnvSettings()" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="13" height="13"><polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
      <span id="trial-badge-text"></span>
    </button>
    <button class="gear-btn" onclick="showEnvSettings()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </button>
  </div>
  <div class="scroll-area">
    <div class="reply-2col desktop-only">
      <!-- Left: Input -->
      <div class="reply-panel">
        <div class="panel-header">
          <h2>ë¦¬ë·° ë‚´ìš©</h2>
        </div>
        <div class="panel-content">
          <textarea id="review-input-desktop" placeholder="ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ì—ì„œ ë¦¬ë·°ë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..." rows="20" oninput="onReviewInputDesktop()"></textarea>
          <div class="char-count" id="review-char-desktop" style="margin-top:12px">0ì</div>
          <button id="generate-btn-desktop" onclick="generateReplyDesktop()" disabled style="width:100%;margin-top:16px">
            <span class="spinner" id="generate-spinner-desktop" style="display:none"></span>
            <span id="generate-btn-content-desktop">ë‹µë³€ ìƒì„±</span>
          </button>
        </div>
      </div>

      <!-- Right: Output -->
      <div class="reply-panel">
        <div class="panel-header">
          <h2>ìƒì„±ëœ ë‹µë³€</h2>
          <div class="panel-actions" id="desktop-actions" style="display:none">
            <button class="btn btn-secondary btn-sm" onclick="copyReplyDesktop()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>ë³µì‚¬
            </button>
            <button class="btn btn-secondary btn-sm" onclick="regenerateReplyDesktop()" id="regen-btn-desktop">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.5"/></svg>ì¬ìƒì„±
            </button>
            <button class="btn btn-secondary btn-sm" onclick="resetFormDesktop()">ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div class="panel-content">
          <div class="reply-output empty" id="reply-output-desktop">ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
          <div class="char-count" id="reply-char-desktop" style="margin-top:12px"></div>
        </div>
      </div>
    </div>

    <!-- Mobile: Original layout -->
    <div class="mobile-only">
      <div class="input-card">
        <div class="input-card-label">ë¦¬ë·° ë‚´ìš©</div>
        <textarea id="review-input" placeholder="ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ì—ì„œ ë¦¬ë·°ë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..." rows="5" oninput="onReviewInput()"></textarea>
        <div class="char-count" id="review-char" style="margin-top:6px">0ì</div>
      </div>

      <button id="generate-btn" onclick="generateReply()" disabled>
        <span class="spinner" id="generate-spinner" style="display:none"></span>
        <span id="generate-btn-content">ë‹µë³€ ìƒì„±</span>
      </button>

      <div class="input-card" style="margin-top:16px">
        <div class="input-card-label">ìƒì„±ëœ ë‹µë³€</div>
        <div class="reply-output empty" id="reply-output">ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
        <div class="char-count" id="reply-char" style="margin-top:6px"></div>
        <div class="copy-row" id="copy-row" style="display:none">
          <button class="btn btn-secondary btn-sm" onclick="copyReply()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>ë³µì‚¬
          </button>
          <button class="btn btn-secondary btn-sm" onclick="regenerateReply()" id="regen-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.5"/></svg>ì¬ìƒì„±
          </button>
          <button class="btn btn-secondary btn-sm" onclick="resetForm()">ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• TEMPLATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-template" class="screen">
  <div class="header">
    <h1>ë¬¸ìÂ·ê³µì§€</h1>
    <span class="subtitle" id="tmpl-clinic-header"></span>
    <button class="gear-btn" onclick="showEnvSettings()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </button>
  </div>
  <!-- íƒ­ -->
  <div class="filter-tabs">
    <button class="filter-tab active" id="tmpl-tab-single" onclick="switchTemplateTab('single')">ê°œë³„ ìƒì„±</button>
    <button class="filter-tab" id="tmpl-tab-batch" onclick="switchTemplateTab('batch')">ì¼ê´„ ìƒì„± (CSV)</button>
  </div>
  <div class="scroll-area">
    <!-- ê°œë³„ ìƒì„± íƒ­ -->
    <div id="tmpl-single-tab">
    <div class="section-title">ìœ í˜• ì„ íƒ</div>
    <div class="tmpl-grid">
      <div class="tmpl-card" data-type="first_visit" onclick="selectTemplate('first_visit')">
        <div class="tmpl-icon">ğŸ¥</div>
        <div class="tmpl-name">ì´ˆì§„ ì•ˆë‚´ ë¬¸ì</div>
        <div class="tmpl-desc">ì²« ë°©ë¬¸ í™˜ì ì•ˆë‚´</div>
      </div>
      <div class="tmpl-card" data-type="after_care" onclick="selectTemplate('after_care')">
        <div class="tmpl-icon">ğŸ’Š</div>
        <div class="tmpl-name">ì¹˜ë£Œ í›„ ì£¼ì˜ì‚¬í•­</div>
        <div class="tmpl-desc">ì‹œìˆ  í›„ ì£¼ì˜ì‚¬í•­</div>
      </div>
      <div class="tmpl-card" data-type="recall" onclick="selectTemplate('recall')">
        <div class="tmpl-icon">ğŸ“…</div>
        <div class="tmpl-name">ì¬ë‚´ì› ìœ ë„ ë¬¸ì</div>
        <div class="tmpl-desc">ì •ê¸° ë‚´ì› ì•ˆë‚´</div>
      </div>
      <div class="tmpl-card" data-type="noshow" onclick="selectTemplate('noshow')">
        <div class="tmpl-icon">â°</div>
        <div class="tmpl-name">ë…¸ì‡¼ ë°©ì§€ ë¦¬ë§ˆì¸ë”</div>
        <div class="tmpl-desc">ì˜ˆì•½ ì•Œë¦¼ ë¬¸ì</div>
      </div>
      <div class="tmpl-card" data-type="holiday" onclick="selectTemplate('holiday')">
        <div class="tmpl-icon">ğŸ””</div>
        <div class="tmpl-name">íœ´ì§„ ê³µì§€</div>
        <div class="tmpl-desc">ì¹´ì¹´ì˜¤/ë¬¸ì/ì¸ìŠ¤íƒ€</div>
      </div>
      <div class="tmpl-card" data-type="sns" onclick="selectTemplate('sns')">
        <div class="tmpl-icon">ğŸ“±</div>
        <div class="tmpl-name">SNS ìº¡ì…˜</div>
        <div class="tmpl-desc">ì¸ìŠ¤íƒ€/ë¸”ë¡œê·¸</div>
      </div>
    </div>

    <div id="tmpl-params">
      <div class="divider"></div>
      <div id="tmpl-fields"></div>
      <button id="tmpl-generate-btn" onclick="generateTemplate()">
        <span class="spinner" id="tmpl-spinner" style="display:none"></span>
        <span id="tmpl-generate-text">ìƒì„±í•˜ê¸°</span>
      </button>
      <div style="margin-top: 20px;">
        <div class="section-title">ìƒì„±ëœ ë‚´ìš©</div>
        <div class="reply-output empty" id="tmpl-output">ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
        <div class="char-count" id="tmpl-char"></div>
        <div class="copy-row" id="tmpl-copy-row" style="display:none">
          <button class="btn btn-secondary btn-sm" onclick="shareTmpl()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>ê³µìœ 
          </button>
          <button class="btn btn-secondary btn-sm" onclick="regenTemplate()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.5"/></svg>ì¬ìƒì„±
          </button>
        </div>
      </div>
    </div>
    </div><!-- end tmpl-single-tab -->

    <!-- ì¼ê´„ ìƒì„± (CSV) íƒ­ -->
    <div id="tmpl-batch-tab" style="display:none">
      <!-- PC: 2-column layout -->
      <div class="desktop-2col">
        <!-- Left: Settings -->
        <div class="batch-settings">
          <div class="section-title">CSV íŒŒì¼ ì—…ë¡œë“œ</div>
          <p style="font-size: 13px; color: var(--text2); margin-bottom: 16px;">í™˜ì ëª©ë¡ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ í•œë²ˆì— ë¬¸ìë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">í…œí”Œë¦¿ ì„ íƒ</label>
            <select id="batch-template-type" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
              <option value="first_visit">ì´ˆì§„ ì•ˆë‚´ ë¬¸ì</option>
              <option value="after_care">ì¹˜ë£Œ í›„ ì£¼ì˜ì‚¬í•­</option>
              <option value="recall">ì¬ë‚´ì› ìœ ë„ ë¬¸ì</option>
              <option value="noshow">ë…¸ì‡¼ ë°©ì§€ ë¦¬ë§ˆì¸ë”</option>
              <option value="holiday">íœ´ì§„ ê³µì§€</option>
              <option value="sns">SNS ìº¡ì…˜</option>
            </select>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">CSV íŒŒì¼</label>
            <input type="file" id="batch-csv-file" accept=".csv" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;" onchange="previewCSV()">
            <p style="font-size: 12px; color: var(--text2); margin-top: 6px;">CSV í˜•ì‹: ì´ë¦„, ì „í™”ë²ˆí˜¸, ì˜ˆì•½ì¼, ì˜ˆì•½ì‹œê°„, ì§„ë£Œë‚´ìš©, ë©”ëª¨</p>
          </div>

          <!-- CSV Preview (PC only) -->
          <div id="csv-preview" class="csv-preview desktop-only" style="display:none">
            <div class="section-title">íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°</div>
            <div class="csv-preview-table">
              <table class="data-table" id="csv-preview-table"></table>
            </div>
            <p class="csv-info">ì´ <strong id="csv-row-count">0</strong>ê±´</p>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="batch-send-sms" style="width: 18px; height: 18px;">
              <span style="font-size: 14px;">ìƒì„± í›„ ì¦‰ì‹œ SMS ë°œì†¡ (Solapi ì—°ë™ í•„ìš”)</span>
            </label>
          </div>

          <button class="btn btn-primary" onclick="batchGenerate()" style="width: 100%; margin-bottom: 20px;">
            <span class="spinner" id="batch-spinner" style="display:none"></span>
            <span id="batch-btn-text">ì¼ê´„ ìƒì„±í•˜ê¸°</span>
          </button>
        </div>

        <!-- Right: Results Table (PC only) -->
        <div class="batch-results desktop-only">
          <div class="section-title">ìƒì„± ê²°ê³¼</div>
          <div id="batch-results-table-container" style="display:none">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ë²ˆí˜¸</th>
                  <th>ì´ë¦„</th>
                  <th>ì „í™”ë²ˆí˜¸</th>
                  <th>ë¬¸ì ë‚´ìš©</th>
                  <th>ì‘ì—…</th>
                </tr>
              </thead>
              <tbody id="batch-results-tbody"></tbody>
            </table>
          </div>
          <div id="batch-results-empty" style="text-align:center;padding:48px;color:var(--text2)">
            ì¼ê´„ ìƒì„± í›„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
          </div>
        </div>
      </div>

      <!-- Mobile: Original layout -->
      <div class="mobile-only" style="padding: 20px;">
        <div class="section-title">CSV íŒŒì¼ ì—…ë¡œë“œ</div>
        <p style="font-size: 13px; color: var(--text2); margin-bottom: 16px;">í™˜ì ëª©ë¡ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ í•œë²ˆì— ë¬¸ìë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">í…œí”Œë¦¿ ì„ íƒ</label>
          <select id="batch-template-type-mobile" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
            <option value="first_visit">ì´ˆì§„ ì•ˆë‚´ ë¬¸ì</option>
            <option value="after_care">ì¹˜ë£Œ í›„ ì£¼ì˜ì‚¬í•­</option>
            <option value="recall">ì¬ë‚´ì› ìœ ë„ ë¬¸ì</option>
            <option value="noshow">ë…¸ì‡¼ ë°©ì§€ ë¦¬ë§ˆì¸ë”</option>
            <option value="holiday">íœ´ì§„ ê³µì§€</option>
            <option value="sns">SNS ìº¡ì…˜</option>
          </select>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">CSV íŒŒì¼</label>
          <input type="file" id="batch-csv-file-mobile" accept=".csv" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
          <p style="font-size: 12px; color: var(--text2); margin-top: 6px;">CSV í˜•ì‹: ì´ë¦„, ì „í™”ë²ˆí˜¸, ì˜ˆì•½ì¼, ì˜ˆì•½ì‹œê°„, ì§„ë£Œë‚´ìš©, ë©”ëª¨</p>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="batch-send-sms-mobile" style="width: 18px; height: 18px;">
            <span style="font-size: 14px;">ìƒì„± í›„ ì¦‰ì‹œ SMS ë°œì†¡</span>
          </label>
        </div>

        <button class="btn btn-primary" onclick="batchGenerateMobile()" style="width: 100%; margin-bottom: 20px;">
          <span class="spinner" id="batch-spinner-mobile" style="display:none"></span>
          <span>ì¼ê´„ ìƒì„±í•˜ê¸°</span>
        </button>

        <div id="batch-results" style="display:none">
          <div class="section-title">ìƒì„± ê²°ê³¼</div>
          <div id="batch-results-list"></div>
        </div>
      </div>
    </div><!-- end tmpl-batch-tab -->

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• HISTORY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-history" class="screen">
  <!-- Mobile header -->
  <div class="header mobile-only">
    <h1>ì´ë ¥</h1>
    <span class="subtitle"></span>
    <button class="gear-btn" onclick="showEnvSettings()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </button>
  </div>

  <!-- PC page header -->
  <div class="page-header desktop-only">
    <h1>ì´ë ¥</h1>
  </div>

  <!-- PC filter panel -->
  <div class="filter-panel desktop-only">
    <input type="text" id="history-search" placeholder="ë¦¬ë·° ë‚´ìš© ê²€ìƒ‰..." oninput="filterHistory()">
    <div class="filter-tabs">
      <button class="filter-tab active" id="filter-all-desktop" onclick="setHistoryFilter('all')">ì „ì²´</button>
      <button class="filter-tab" id="filter-review-desktop" onclick="setHistoryFilter('review')">ë¦¬ë·° ë‹µë³€</button>
      <button class="filter-tab" id="filter-template-desktop" onclick="setHistoryFilter('template')">ë¬¸ìÂ·ê³µì§€</button>
    </div>
    <select id="history-sort" onchange="sortHistory()">
      <option value="date_desc">ìµœì‹ ìˆœ</option>
      <option value="date_asc">ì˜¤ë˜ëœìˆœ</option>
    </select>
  </div>

  <!-- Mobile filter tabs -->
  <div class="filter-tabs mobile-only">
    <button class="filter-tab active" id="filter-all" onclick="setHistoryFilter('all')">ì „ì²´</button>
    <button class="filter-tab" id="filter-review" onclick="setHistoryFilter('review')">ë¦¬ë·° ë‹µë³€</button>
    <button class="filter-tab" id="filter-template" onclick="setHistoryFilter('template')">ë¬¸ìÂ·ê³µì§€</button>
  </div>

  <div class="scroll-area" id="history-list">
    <!-- Mobile: card view -->
    <div class="history-cards mobile-only" id="history-cards">
      <div class="empty-state"><div class="emoji">ğŸ“‹</div>ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>
    </div>

    <!-- PC: table view -->
    <div class="data-table-container desktop-only">
      <table class="data-table">
        <thead>
          <tr>
            <th>ìœ í˜•</th>
            <th>ë‚ ì§œ/ì‹œê°„</th>
            <th>ì›ë³¸</th>
            <th>ìƒì„± ê²°ê³¼</th>
            <th>ê¸€ììˆ˜</th>
            <th>ì‘ì—…</th>
          </tr>
        </thead>
        <tbody id="history-table-body">
          <tr><td colspan="6" style="text-align:center;padding:48px;color:var(--text2)">ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• ADMIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-admin" class="screen">
  <div class="admin-header">
    <button class="back-btn" onclick="window.location.href='/'">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><polyline points="15 18 9 12 15 6"/></svg>
    </button>
    <h1>ğŸ” Clinote Admin</h1>
  </div>
  <div class="admin-tabs">
    <button class="admin-tab active" onclick="switchAdminTab('stats', this)">í†µê³„</button>
    <button class="admin-tab" onclick="switchAdminTab('users', this)">íšŒì›</button>
    <button class="admin-tab" onclick="switchAdminTab('popup', this)">íŒì—…</button>
  </div>
  <div style="overflow-y:auto;flex:1">
    <!-- í†µê³„ -->
    <div id="admin-pane-stats" class="admin-pane active">
      <div class="stat-grid">
        <div class="stat-card"><div class="stat-val" id="stat-users">-</div><div class="stat-label">ì´ ê°€ì…ì</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-subs">-</div><div class="stat-label">í™œì„± êµ¬ë…</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-new-today">-</div><div class="stat-label">ì˜¤ëŠ˜ ì‹ ê·œ</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-new-month">-</div><div class="stat-label">ì´ë²ˆë‹¬ ì‹ ê·œ</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-today">-</div><div class="stat-label">ì˜¤ëŠ˜ ìƒì„±</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-month">-</div><div class="stat-label">ì´ë²ˆë‹¬ ìƒì„±</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-total">-</div><div class="stat-label">ëˆ„ì  ìƒì„±</div></div>
      </div>
      <div style="padding:16px 0 8px;font-size:13px;font-weight:600;color:var(--text2)">í”Œëœ ë¶„í¬</div>
      <div class="stat-grid" style="grid-template-columns:repeat(3,1fr)">
        <div class="stat-card"><div class="stat-val" id="stat-free">-</div><div class="stat-label">ë¬´ë£Œ</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-beta">-</div><div class="stat-label">ë² íƒ€</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-pro">-</div><div class="stat-label">Pro</div></div>
      </div>
    </div>
    <!-- íšŒì› -->
    <div id="admin-pane-users" class="admin-pane">
      <div style="display:flex;gap:8px;padding:4px 0 12px;flex-wrap:wrap;align-items:center">
        <input type="text" id="user-search" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰" oninput="filterUsers()"
          style="flex:1;min-width:120px;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--input-bg);color:var(--text);font-size:14px">
        <div style="display:flex;gap:4px">
          <button class="ufilter active" data-plan="all" onclick="setUserFilter(this,'all')">ì „ì²´</button>
          <button class="ufilter" data-plan="free" onclick="setUserFilter(this,'free')">ë¬´ë£Œ</button>
          <button class="ufilter" data-plan="beta" onclick="setUserFilter(this,'beta')">ë² íƒ€</button>
          <button class="ufilter" data-plan="pro" onclick="setUserFilter(this,'pro')">Pro</button>
        </div>
      </div>
      <div id="admin-user-list"><div style="color:var(--text2);font-size:14px">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
    </div>
    <!-- íŒì—… -->
    <div id="admin-pane-popup" class="admin-pane">
      <div class="admin-field">
        <label>ì´ë¯¸ì§€ URL <span style="font-weight:400;color:var(--muted);font-size:12px;">ê¶Œì¥: 640Ã—800px (4:5)</span></label>
        <input type="text" id="popup-image-url" placeholder="https://..." oninput="previewPopupImg()">
      </div>
      <div class="admin-field">
        <label>ë§í¬ URL (ì„ íƒ)</label>
        <input type="text" id="popup-link-url" placeholder="https://...">
      </div>
      <div class="admin-field">
        <label>ì œëª© (ì„ íƒ)</label>
        <input type="text" id="popup-title" placeholder="ê³µì§€ ì œëª©">
      </div>
      <div class="admin-field">
        <label class="admin-toggle">
          <input type="checkbox" id="popup-active" style="width:auto">
          íŒì—… í™œì„±í™”
        </label>
      </div>
      <div class="popup-preview" id="popup-preview" style="display:none">
        <img id="popup-preview-img" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
      </div>
      <button id="popup-save-btn" onclick="saveAdminPopup()" style="margin-top:16px;width:100%;padding:14px;background:var(--accent);color:#fff;border:none;border-radius:var(--radius);font-size:15px;font-weight:700;cursor:pointer">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• CLINIC (ë³‘ì›ì •ë³´) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-clinic" class="screen">
  <div class="header">
    <h1>ë³‘ì›ì •ë³´</h1>
    <button class="gear-btn" onclick="showEnvSettings()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </button>
  </div>
  <div class="scroll-area">
    <p class="settings-header">ë³‘ì› ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ë§ì¶¤í˜• ë‹µë³€ê³¼ ë¬¸ìë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

    <div class="section-title">ê¸°ë³¸ ì •ë³´</div>

    <div class="form-group">
      <label>ë³‘ì›ëª… *</label>
      <input type="text" id="s-name" placeholder="ì˜ˆ: ì„œìš¸ìŠ¤ë§ˆì¼ì¹˜ê³¼">
    </div>

    <div class="form-group">
      <label>ì§„ë£Œê³¼ëª©</label>
      <select id="s-specialty" onchange="onSpecialtyChange()">
        <option value="ì¹˜ê³¼">ì¹˜ê³¼</option>
        <option value="í•œì˜ì›">í•œì˜ì›</option>
        <option value="í”¼ë¶€ê³¼">í”¼ë¶€ê³¼</option>
        <option value="ì„±í˜•ì™¸ê³¼">ì„±í˜•ì™¸ê³¼</option>
        <option value="ì•ˆê³¼">ì•ˆê³¼</option>
        <option value="ì´ë¹„ì¸í›„ê³¼">ì´ë¹„ì¸í›„ê³¼</option>
        <option value="ì •í˜•ì™¸ê³¼">ì •í˜•ì™¸ê³¼</option>
        <option value="ë‚´ê³¼">ë‚´ê³¼</option>
        <option value="ë™ë¬¼ë³‘ì›">ë™ë¬¼ë³‘ì›</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
      </select>
    </div>

    <div class="form-group">
      <label>ì›ì¥ë‹˜ ì„±í•¨ (ì„ íƒ)</label>
      <input type="text" id="s-doctor" placeholder="ì˜ˆ: ê¹€ë¯¼ì¤€">
    </div>

    <div class="form-group">
      <label>ë‹µë³€ ë§íˆ¬</label>
      <select id="s-tone">
        <option value="formal">ì •ì¤‘í•˜ê³  ê³µì‹ì ì¸ ë§íˆ¬</option>
        <option value="friendly">ì¹œê·¼í•˜ê³  ë”°ëœ»í•œ ë§íˆ¬</option>
        <option value="professional">ì „ë¬¸ì ì´ê³  ì‹ ë¢°ê° ìˆëŠ” ë§íˆ¬</option>
      </select>
    </div>

    <div class="divider"></div>
    <div class="section-title">ì—°ë½ì²˜</div>

    <div class="form-group">
      <label>ì „í™”ë²ˆí˜¸</label>
      <input type="tel" id="s-phone" placeholder="ì˜ˆ: 02-1234-5678">
    </div>

    <div class="form-group">
      <label>ë„¤ì´ë²„ ì§€ë„ ë§í¬</label>
      <input type="url" id="s-naver-map" placeholder="https://naver.me/...">
    </div>

    <div class="divider"></div>
    <div class="section-title">SNS / ì±„ë„</div>

    <div class="form-group">
      <label>ì¸ìŠ¤íƒ€ê·¸ë¨</label>
      <input type="text" id="s-instagram" placeholder="ì˜ˆ: @seoul_smile_dental ë˜ëŠ” URL">
    </div>

    <div class="form-group">
      <label>ì¹´ì¹´ì˜¤ ì±„ë„</label>
      <input type="text" id="s-kakao-channel" placeholder="ì˜ˆ: @ì„œìš¸ìŠ¤ë§ˆì¼ì¹˜ê³¼ ë˜ëŠ” ì±„ë„ URL">
    </div>

    <div class="divider"></div>
    <div class="section-title">ë‹µë³€ ìŠ¤íƒ€ì¼</div>

    <!-- ê°•ì¡°ì‚¬í•­: ì¹© ì„ íƒ + ì»¤ìŠ¤í…€ -->
    <div class="form-group">
      <label>ê°•ì¡° ì‚¬í•­</label>
      <div class="chip-label">ìì£¼ ì“°ëŠ” í•­ëª© íƒ­í•´ì„œ ì¶”ê°€</div>
      <div class="chip-group" id="emphasis-chips"></div>
      <div class="add-tag-row">
        <input type="text" id="s-emphasis-input" placeholder="ì§ì ‘ ì…ë ¥ í›„ ì¶”ê°€" onkeydown="if(event.key==='Enter'){addEmphasis();event.preventDefault();}">
        <button class="btn btn-secondary btn-sm" onclick="addEmphasis()">ì¶”ê°€</button>
      </div>
      <div class="tags-wrap" id="emphasis-tags"></div>
    </div>

    <!-- ê¸ˆì§€ì–´ -->
    <div class="form-group">
      <label>ê¸ˆì§€ì–´</label>
      <div class="chip-label">ìì£¼ ì“°ëŠ” ê¸ˆì§€ì–´ ì˜ˆì‹œ</div>
      <div class="chip-group">
        <div class="chip" onclick="addForbiddenChip('ìµœê³ ')">ìµœê³ </div>
        <div class="chip" onclick="addForbiddenChip('1ë“±')">1ë“±</div>
        <div class="chip" onclick="addForbiddenChip('ì „êµ­ ìµœì´ˆ')">ì „êµ­ ìµœì´ˆ</div>
        <div class="chip" onclick="addForbiddenChip('ì™„ì¹˜')">ì™„ì¹˜</div>
        <div class="chip" onclick="addForbiddenChip('ë³´ì¥')">ë³´ì¥</div>
        <div class="chip" onclick="addForbiddenChip('100%')">100%</div>
        <div class="chip" onclick="addForbiddenChip('ë¬´ì¡°ê±´')">ë¬´ì¡°ê±´</div>
        <div class="chip" onclick="addForbiddenChip('íŠ¹íš¨')">íŠ¹íš¨</div>
      </div>
      <div class="add-tag-row">
        <input type="text" id="s-forbidden-input" placeholder="ê¸ˆì§€ì–´ ì…ë ¥ í›„ ì¶”ê°€" onkeydown="if(event.key==='Enter'){addForbiddenWord();event.preventDefault();}">
        <button class="btn btn-secondary btn-sm" onclick="addForbiddenWord()">ì¶”ê°€</button>
      </div>
      <div class="forbidden-tags" id="forbidden-tags"></div>
    </div>

    <button class="btn btn-primary" onclick="saveSettings()">
      <span id="settings-btn-text">ì„¤ì • ì €ì¥</span>
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• ENV SETTINGS (í™˜ê²½ì„¤ì •) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-env" class="screen">
  <div class="header">
    <button class="back-btn" onclick="goBack()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="22" height="22"><polyline points="15 18 9 12 15 6"/></svg>
    </button>
    <h1>í™˜ê²½ì„¤ì •</h1>
  </div>
  <div class="scroll-area" style="padding:20px 20px 40px">

    <!-- í”„ë¡œí•„ -->
    <div class="env-profile-section">
      <div class="env-avatar" id="env-avatar">?</div>
      <div class="env-nickname" id="env-nickname">ë¡œë”© ì¤‘...</div>
      <div class="env-subtitle">ì¹´ì¹´ì˜¤ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë¨</div>
    </div>

    <!-- êµ¬ë… -->
    <div class="env-section-label">êµ¬ë…</div>
    <div class="env-list-card">
      <div class="env-list-row">
        <label>í˜„ì¬ í”Œëœ</label>
        <span id="sub-plan-badge" class="env-row-value" style="font-size:12px;font-weight:700;padding:3px 8px;border-radius:20px;background:#f0fdf4;color:#16a34a">ë² íƒ€ ë¬´ë£Œ</span>
      </div>
      <div class="env-list-row" id="sub-trial-row" style="display:none">
        <label>ì²´í—˜ ê¸°ê°„</label>
        <span id="sub-trial-text" style="font-size:13px;color:var(--text2)"></span>
      </div>
      <div class="env-list-row" id="sub-usage-row" style="display:none">
        <label>ì²´í—˜ ì‚¬ìš©ëŸ‰</label>
        <span id="sub-usage-text" style="font-size:13px;color:var(--text2)"></span>
      </div>
      <div class="env-list-row" onclick="toast('êµ¬ë… ê¸°ëŠ¥ì€ ì •ì‹ ì¶œì‹œ ì‹œ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤')" style="cursor:pointer">
        <label style="cursor:pointer">êµ¬ë… ê´€ë¦¬</label>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
    </div>

    <!-- ë°ì´í„° ê´€ë¦¬ -->
    <div class="env-section-label">ë°ì´í„° ê´€ë¦¬</div>
    <div class="env-list-card">
      <div class="env-list-row" onclick="clearAllHistory()" style="cursor:pointer">
        <label style="cursor:pointer">ì „ì²´ ì´ë ¥ ì‚­ì œ</label>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
    </div>

    <!-- ì•± ì •ë³´ -->
    <div class="env-section-label">ì•± ì •ë³´</div>
    <div class="env-list-card">
      <div class="env-list-row" onclick="showNotices()" style="cursor:pointer">
        <label style="cursor:pointer">ê³µì§€ì‚¬í•­</label>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
      <div class="env-list-row">
        <label>ë²„ì „</label>
        <span class="env-row-value">v1.0.0</span>
      </div>
    </div>

    <!-- ê³„ì • -->
    <div class="env-section-label">ê³„ì •</div>
    <div class="env-list-card">
      <div class="env-list-row" onclick="doLogout()" style="cursor:pointer">
        <label style="cursor:pointer">ë¡œê·¸ì•„ì›ƒ</label>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
      <div class="env-list-row destructive" onclick="deleteAccount()" style="cursor:pointer">
        <label style="cursor:pointer;color:var(--red)">íšŒì› íƒˆí‡´</label>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      </div>
    </div>

    <div style="padding:24px 4px 8px;display:flex;gap:16px;justify-content:center">
      <a href="/terms" target="_blank" style="font-size:12px;color:var(--text2);text-decoration:none;border-bottom:1px solid var(--border)">ì´ìš©ì•½ê´€</a>
      <a href="/privacy" target="_blank" style="font-size:12px;color:var(--text2);text-decoration:none;border-bottom:1px solid var(--border)">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
    </div>
    <div style="text-align:center;padding:12px 24px 24px;">
      <p style="font-size:11px;color:var(--text2);line-height:1.5;margin-bottom:4px;">
        <strong style="color:var(--text);">Clinote (ë¸”ë¦¬ì¹˜)</strong> | ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 123-45-03602
      </p>
      <p style="font-size:11px;color:var(--text2);line-height:1.5;margin-bottom:8px;">
        ëŒ€í‘œ: ì´ë¯¼ê²½ | ì´ë©”ì¼: designbleach@gmail.com
      </p>
      <p style="font-size:11px;color:var(--text2);opacity:0.6">Â© 2026 Clinote. All rights reserved.</p>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• NOTICE MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="notice-modal" style="display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.4)" onclick="if(event.target===this)closeNotices()">
  <div style="position:absolute;bottom:0;left:0;right:0;background:var(--bg);border-radius:20px 20px 0 0;padding:24px 20px 40px;max-height:75vh;overflow-y:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <span style="font-size:18px;font-weight:800;letter-spacing:-0.4px">ê³µì§€ì‚¬í•­</span>
      <button onclick="closeNotices()" style="background:none;border:none;cursor:pointer;font-size:22px;color:var(--text2);line-height:1">Ã—</button>
    </div>
    <div class="notice-item">
      <div class="notice-date">2025.06 Â· í´ë¡œì¦ˆ ë² íƒ€</div>
      <div class="notice-title">Clinote í´ë¡œì¦ˆ ë² íƒ€ ì‹œì‘ ğŸ‰</div>
      <div class="notice-body">ë² íƒ€ í…ŒìŠ¤í„°ë¡œ ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. í˜„ì¬ ì„œë¹„ìŠ¤ëŠ” ë² íƒ€ ê¸°ê°„ ì¤‘ ë¬´ë£Œë¡œ ìš´ì˜ë©ë‹ˆë‹¤. í”¼ë“œë°±ì€ ì–¸ì œë“  ì›ì¥ë‹˜ê»˜ ì§ì ‘ ì „ë‹¬í•´ ì£¼ì„¸ìš”. ë” ì¢‹ì€ ì„œë¹„ìŠ¤ë¡œ ë°œì „í•˜ê² ìŠµë‹ˆë‹¤.</div>
    </div>
  </div>
</div>

</div><!-- end main-content -->

<!-- â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="bottom-nav" id="bottom-nav">
  <button class="nav-btn active" id="nav-reply" onclick="showScreen('reply')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    ë¦¬ë·° ë‹µë³€
  </button>
  <button class="nav-btn" id="nav-template" onclick="showScreen('template')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
    ë¬¸ìÂ·ê³µì§€
  </button>
  <button class="nav-btn" id="nav-history" onclick="showScreen('history')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    ì´ë ¥
  </button>
  <button class="nav-btn" id="nav-clinic" onclick="showScreen('clinic')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    ë³‘ì›ì •ë³´
  </button>
</nav>

<div id="toast"></div>

<script>
// â•â• Data â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SPECIALTY_EMPHASIS = {
  'ì¹˜ê³¼': [
    'ë¬´í†µ ë§ˆì·¨', 'ì„í”Œë€íŠ¸ ì „ë¬¸', 'ì–´ë¦°ì´ ì¹˜ê³¼', 'ë‹¹ì¼ ì‘ê¸‰ì§„ë£Œ',
    'íˆ¬ëª…êµì •(ì¸ë¹„ì ˆë¼ì¸)', 'ì„¸ë¼ë¯¹ êµì •', 'ë¼ë¯¸ë„¤ì´íŠ¸', 'ì‡ëª¸ ì¹˜ë£Œ',
    'ë‹¹ì¼ ì„í”Œë€íŠ¸', 'ë””ì§€í„¸ êµ¬ê°•ìŠ¤ìºë„ˆ', 'ìˆ˜ë©´ ì§„ë£Œ', 'ì¹˜ì•„ë¯¸ë°±',
    'í‹€ë‹ˆÂ·ë³´ì²  ì „ë¬¸', 'ì‚¬ë‘ë‹ˆ ë‹¹ì¼ ë°œì¹˜', 'ì „ë¬¸ì˜ ìƒì£¼', 'í„±ê´€ì ˆ ì¹˜ë£Œ',
    'ì¹˜ì•„ ì„±í˜•', 'ë ˆì§„ ìˆ˜ë³µ', 'ì˜ë£Œë³´í—˜ ì ìš©',
  ],
  'í•œì˜ì›': [
    'ì¶”ë‚˜ìš”ë²•', 'ì¹¨ ì¹˜ë£Œ', 'í•œì•½ ì²˜ë°©', 'ë‹¤ì´ì–´íŠ¸ í•œì˜ì›',
    'ë¶ˆì„Â·ë‚œì„ ì¹˜ë£Œ', 'ì²´ì§ˆ ë¶„ì„', 'ë””ìŠ¤í¬ ì¹˜ë£Œ', 'ê°±ë…„ê¸° ì¹˜ë£Œ',
    'ì†Œì•„ í•œì˜í•™', 'ìŠ¤í¬ì¸  í•œì˜', 'í™”ë³‘ ì¹˜ë£Œ', 'í”¼ë¶€ í•œì˜',
    'ì•¼ê°„ ì§„ë£Œ', 'ë‹¹ì¼ í•œì•½ ì¡°ì œ', 'ë¹„ê¸‰ì—¬ í•­ëª© íˆ¬ëª… ê³µê°œ',
  ],
  'í”¼ë¶€ê³¼': [
    'ë ˆì´ì € ì¹˜ë£Œ', 'ë³´í†¡ìŠ¤', 'í•„ëŸ¬', 'í”¼ë¶€ ë¯¸ë°±',
    'ì—¬ë“œë¦„ ì¹˜ë£Œ', 'ì•„í† í”¼ ì „ë¬¸', 'ë¦¬í”„íŒ…', 'ìƒ‰ì†Œ ì¹˜ë£Œ',
    'ì‹¤ ë¦¬í”„íŒ…', 'ëª¨ê³µ ì¹˜ë£Œ', 'íƒˆëª¨ ì¹˜ë£Œ', 'ì œëª¨ ë ˆì´ì €',
    'í‰í„° ì¹˜ë£Œ', 'í”¼ë¶€ ê±´ê°•ê²€ì§„', 'í•´ì™¸ ë¸Œëœë“œ ì œí’ˆ ì‚¬ìš©',
  ],
  'ì„±í˜•ì™¸ê³¼': [
    'ìì—°ìŠ¤ëŸ¬ìš´ ê²°ê³¼', 'ìŒêº¼í’€ ì „ë¬¸', 'ì½” ì„±í˜•', 'ì§€ë°©í¡ì…',
    'ëˆˆ ì„±í˜•', 'ì•ˆë©´ìœ¤ê³½', 'ìˆ˜ì •Â·ì¬ìˆ˜ìˆ  ì „ë¬¸', 'ë¬´í‰í„° ê¸°ë²•',
    'ê°€ìŠ´ ì„±í˜•', 'ë°”ë”” ì»¨íˆ¬ì–´ë§', 'ì™¸êµ­ì¸ í™˜ì ê²½í—˜ í’ë¶€',
  ],
  'ì•ˆê³¼': [
    'ë¼ì‹Â·ë¼ì„¹ ì „ë¬¸', 'ìŠ¤ë§ˆì¼ ë¼ì‹', 'ë°±ë‚´ì¥ ìˆ˜ìˆ ',
    'ë§ë§‰ ì „ë¬¸', 'ë…¹ë‚´ì¥ ì¹˜ë£Œ', 'ë“œë¦¼ë Œì¦ˆ', 'ë…¸ì•ˆ êµì •',
    'ì†Œì•„ ì•ˆê³¼', 'ì˜ë£Œìš© ì½˜íƒíŠ¸ë Œì¦ˆ', '3D ì•ˆì € ì´¬ì˜',
  ],
  'ì´ë¹„ì¸í›„ê³¼': [
    'ì½” ìˆ˜ìˆ Â·ê¸°ëŠ¥ êµì •', 'í¸ë„ ìˆ˜ìˆ ', 'ì¤‘ì´ì—¼ ì¹˜ë£Œ',
    'ìˆ˜ë©´ë¬´í˜¸í¡', 'ì•Œë ˆë¥´ê¸° ì¹˜ë£Œ', 'ë³´ì²­ê¸° ìƒë‹´', 'í›„ë‘Â·ìŒì„± ì¹˜ë£Œ',
    'êµ¬ë‚´ì—¼Â·í¸ë„ì—¼', 'ë¹„ì—¼ ì¹˜ë£Œ', 'ì²­ê° ê²€ì‚¬',
  ],
  'ì •í˜•ì™¸ê³¼': [
    'ê´€ì ˆ ë‚´ì‹œê²½', 'ì²™ì¶” ì „ë¬¸', 'ìŠ¤í¬ì¸  ì†ìƒ', 'ì¸ê³µê´€ì ˆ',
    'ë„ìˆ˜ì¹˜ë£Œ', 'ì²´ì™¸ì¶©ê²©íŒŒ', 'ì¬í™œì¹˜ë£Œ', 'ì£¼ì‚¬ ì¹˜ë£Œ',
    'ê³¨ì ˆÂ·ì™¸ìƒ', 'MRI ì¦‰ì‹œ íŒë…',
  ],
  'ë‚´ê³¼': [
    'ê±´ê°•ê²€ì§„', 'ë‹¹ë‡¨ ì „ë¬¸', 'ê³ í˜ˆì•• ê´€ë¦¬', 'ì†Œí™”ê¸° ì „ë¬¸',
    'ê°‘ìƒì„  ì¹˜ë£Œ', 'ê°„ ì§ˆí™˜', 'ê¸ˆì—° í´ë¦¬ë‹‰', 'ì˜ì–‘ ìˆ˜ì•¡',
    'ìˆ˜ë©´ ë‚´ì‹œê²½', 'ëŒ€ì¥ ë‚´ì‹œê²½', 'ìœ„ ë‚´ì‹œê²½',
  ],
  'ë™ë¬¼ë³‘ì›': [
    '24ì‹œê°„ ì‘ê¸‰', 'ë‚´ê³¼ ì „ë¬¸', 'ì™¸ê³¼ ìˆ˜ìˆ ', 'ì¹˜ê³¼ ìŠ¤ì¼€ì¼ë§',
    'ì˜ˆë°©ì ‘ì¢…', 'í”¼ë¶€ ì „ë¬¸', 'ì•ˆê³¼ ì „ë¬¸', 'ì˜ì–‘ ìƒë‹´',
    'ê³ ì–‘ì´ ì „ë¬¸', 'ê°•ì•„ì§€ ì „ë¬¸', 'í¬ê·€ ë™ë¬¼ ì§„ë£Œ', 'ì…ì›ì‹¤ ìš´ì˜',
    'ëª¨ë°”ì¼ X-ray', 'ì‹¬ì¥ ì´ˆìŒíŒŒ',
  ],
  'ê¸°íƒ€': [
    'ì „ë¬¸ì˜ ìƒì£¼', 'ë‹¹ì¼ ì§„ë£Œ', 'ì˜ˆì•½ì œ ìš´ì˜', 'ì£¼ì°¨ ê°€ëŠ¥',
    'ì•¼ê°„ ì§„ë£Œ', 'í† Â·ì¼ ì§„ë£Œ', 'ì¹œì ˆí•œ ìƒë‹´', 'ì²­ê²°í•œ í™˜ê²½',
    'ë¹„ê¸‰ì—¬ í•­ëª© íˆ¬ëª… ê³µê°œ', 'ì™¸êµ­ì–´ ê°€ëŠ¥',
  ],
};

const TEMPLATES = {
  first_visit: {
    label: 'ì´ˆì§„ ì•ˆë‚´ ë¬¸ì',
    fields: [
      {
        id: 'appt_date', label: 'ì˜ˆì•½ ë‚ ì§œÂ·ì‹œê°„', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ ì˜ˆì‹œ íƒ­',
        chips: ['ë‚´ì¼ ì˜¤ì „ 10ì‹œ', 'ë‚´ì¼ ì˜¤í›„ 2ì‹œ', 'ì´ë²ˆ ì£¼ í† ìš”ì¼ ì˜¤ì „', 'ë‹¤ìŒ ì£¼ ì›”ìš”ì¼'],
      },
      {
        id: 'note', label: 'ì¶”ê°€ ì•ˆë‚´ (ì„ íƒ)', required: false, textarea: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ ì˜ˆì‹œ íƒ­',
        chips: ['ì£¼ì°¨ ê°€ëŠ¥', 'ëŒ€ì¤‘êµí†µ ì´ìš© ê¶Œì¥', 'ì ‘ìˆ˜ 5ë¶„ ì „ ë„ì°© ê¶Œì¥', 'ì‹ ë¶„ì¦ ì§€ì°¸ ìš”ì²­', 'ë³´í˜¸ì ë™ë°˜ ê¶Œì¥'],
      },
    ]
  },
  after_care: {
    label: 'ì¹˜ë£Œ í›„ ì£¼ì˜ì‚¬í•­',
    fields: [
      {
        id: 'treatment', label: 'ì¹˜ë£Œ í•­ëª©', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: {
          'ì¹˜ê³¼': ['ì„í”Œë€íŠ¸ ìˆ˜ìˆ ', 'ìŠ¤ì¼€ì¼ë§', 'ì‹ ê²½ì¹˜ë£Œ', 'ë°œì¹˜', 'ë³´ì²  ì¥ì°©', 'êµì • ì¥ì¹˜ ë¶€ì°©', 'ì¹˜ì•„ë¯¸ë°±', 'ì‡ëª¸ ì¹˜ë£Œ', 'ë¼ë¯¸ë„¤ì´íŠ¸', 'ë ˆì§„ ìˆ˜ë³µ'],
          'í”¼ë¶€ê³¼': ['ë ˆì´ì € ì‹œìˆ ', 'ë³´í†¡ìŠ¤', 'í•„ëŸ¬', 'ë°•í”¼', 'ë¦¬í”„íŒ…', 'ì œëª¨'],
          'ì •í˜•ì™¸ê³¼': ['ê´€ì ˆ ë‚´ì‹œê²½', 'ì£¼ì‚¬ ì¹˜ë£Œ', 'ë„ìˆ˜ì¹˜ë£Œ', 'ì²´ì™¸ì¶©ê²©íŒŒ'],
          'í•œì˜ì›': ['ì¹¨ ì¹˜ë£Œ', 'ëœ¸ ì¹˜ë£Œ', 'ì¶”ë‚˜ìš”ë²•', 'í•œì•½ ë³µìš© ì‹œì‘'],
          default: ['ìˆ˜ìˆ ', 'ì‹œìˆ ', 'ì£¼ì‚¬ ì¹˜ë£Œ', 'ë ˆì´ì € ì¹˜ë£Œ', 'ì²˜ì¹˜'],
        },
      },
      {
        id: 'note', label: 'ì¶”ê°€ ì•ˆë‚´ (ì„ íƒ)', required: false, textarea: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['í•­ìƒì œ ì²˜ë°©ë¨', 'ì§„í†µì œ ì²˜ë°©ë¨', '3ì¼ í›„ ì¬ë‚´ì› í•„ìš”', '1ì£¼ì¼ í›„ ì‹¤ë°¥ ì œê±°', 'ëƒ‰ì°œì§ˆ ê¶Œì¥', 'ìŒì£¼Â·í¡ì—° ê¸ˆì§€ 1ì£¼', 'ê²©í•œ ìš´ë™ ê¸ˆì§€'],
      },
    ]
  },
  recall: {
    label: 'ì¬ë‚´ì› ìœ ë„ ë¬¸ì',
    fields: [
      {
        id: 'interval', label: 'ê¶Œì¥ ë‚´ì› ì£¼ê¸°', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['3ê°œì›”', '6ê°œì›”', '1ë…„', '2ë…„', 'ë§¤ì›”'],
      },
      {
        id: 'service', label: 'ê¶Œì¥ ì„œë¹„ìŠ¤', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: {
          'ì¹˜ê³¼': ['ìŠ¤ì¼€ì¼ë§', 'ì •ê¸° ê²€ì§„', 'ë¶ˆì†Œ ë„í¬', 'ì‹¤ë€íŠ¸', 'êµì • ì ê²€', 'ì„í”Œë€íŠ¸ ì ê²€', 'êµ¬ê°• ìœ„ìƒ ê´€ë¦¬'],
          'ì•ˆê³¼': ['ì‹œë ¥ ê²€ì‚¬', 'ì•ˆì•• ê²€ì‚¬', 'ë“œë¦¼ë Œì¦ˆ ì ê²€'],
          'ë‚´ê³¼': ['í˜ˆì•¡ ê²€ì‚¬', 'í˜ˆì•• ì¸¡ì •', 'í˜ˆë‹¹ ì¸¡ì •', 'ê±´ê°•ê²€ì§„'],
          default: ['ì •ê¸° ê²€ì§„', 'ì¶”ì  ê´€ì°°', 'ì¹˜ë£Œ í›„ ì ê²€'],
        },
      },
    ]
  },
  noshow: {
    label: 'ë…¸ì‡¼ ë°©ì§€ ë¦¬ë§ˆì¸ë”',
    fields: [
      {
        id: 'appt_date', label: 'ì˜ˆì•½ ë‚ ì§œÂ·ì‹œê°„', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['ë‚´ì¼ ì˜¤ì „ 10ì‹œ', 'ë‚´ì¼ ì˜¤í›„ 2ì‹œ', 'ë‚´ì¼ ì˜¤í›„ 4ì‹œ', 'ëª¨ë ˆ ì˜¤ì „ 11ì‹œ'],
      },
      {
        id: 'treatment', label: 'ì˜ˆì•½ ì§„ë£Œ (ì„ íƒ)', required: false,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: {
          'ì¹˜ê³¼': ['ì„í”Œë€íŠ¸ ìƒë‹´', 'ìŠ¤ì¼€ì¼ë§', 'ì‹ ê²½ì¹˜ë£Œ', 'ë³´ì²  ì ê²€', 'êµì • ì ê²€', 'ë°œì¹˜'],
          default: ['ìƒë‹´', 'ì •ê¸° ê²€ì§„', 'ì²˜ì¹˜', 'ìˆ˜ìˆ  ì „ ê²€ì‚¬'],
        },
      },
    ]
  },
  holiday: {
    label: 'íœ´ì§„ ê³µì§€',
    fields: [
      {
        id: 'date_range', label: 'íœ´ì§„ ê¸°ê°„', required: true,
        placeholder: 'ì˜ˆ: 3ì›” 1ì¼(í† )~3ì¼(ì›”)',
        chips: [],
      },
      {
        id: 'reason', label: 'ì‚¬ìœ  (ì„ íƒ)', required: false,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['ì„¤ ì—°íœ´', 'ì¶”ì„ ì—°íœ´', 'í•™íšŒ ì°¸ì„', 'ë³‘ì› ë¦¬ëª¨ë¸ë§', 'ì›ì¥ë‹˜ ë¶€ì¬', 'ê³µíœ´ì¼'],
      },
      {
        id: 'resume_date', label: 'ì •ìƒ ì§„ë£Œ ì¬ê°œì¼', required: true,
        placeholder: 'ì˜ˆ: 3ì›” 4ì¼(í™”)ë¶€í„° ì •ìƒ ì§„ë£Œ',
        chips: [],
      },
      {
        id: 'channel', label: 'ì±„ë„ (ì„ íƒ)', required: false,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['ì¹´ì¹´ì˜¤', 'ë¬¸ì', 'ì¸ìŠ¤íƒ€ê·¸ë¨', 'ë„¤ì´ë²„ ë¸”ë¡œê·¸'],
      },
    ]
  },
  sns: {
    label: 'SNS ìº¡ì…˜',
    fields: [
      {
        id: 'topic', label: 'ì£¼ì œ', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: {
          'ì¹˜ê³¼': ['ì„í”Œë€íŠ¸ ì´ë²¤íŠ¸', 'ìŠ¤ì¼€ì¼ë§ ì•ˆë‚´', 'íˆ¬ëª…êµì • ìƒë‹´', 'ì¹˜ì•„ë¯¸ë°± ì´ë²¤íŠ¸', 'ì–´ë¦°ì´ë‚  ì´ë²¤íŠ¸', 'ê³„ì ˆ ì¸ì‚¬'],
          'í”¼ë¶€ê³¼': ['ë³´í†¡ìŠ¤ ì´ë²¤íŠ¸', 'ì—¬ë“œë¦„ ì¹˜ë£Œ', 'ë ˆì´ì € ë¦¬í”„íŒ…', 'ê°€ì„ í”¼ë¶€ê´€ë¦¬'],
          default: ['ì‹ ê·œ ì¥ë¹„ ë„ì…', 'ì´ë²¤íŠ¸ ì•ˆë‚´', 'ê³„ì ˆ ì¸ì‚¬', 'ê±´ê°• ì •ë³´', 'ì›ì¥ë‹˜ ì†Œê°œ'],
        },
      },
      {
        id: 'platform', label: 'SNS ì±„ë„', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['ì¸ìŠ¤íƒ€ê·¸ë¨', 'ë„¤ì´ë²„ ë¸”ë¡œê·¸', 'ì¹´ì¹´ì˜¤ìŠ¤í† ë¦¬', 'ìœ íŠœë¸Œ ì‡¼ì¸ '],
      },
      {
        id: 'note', label: 'ì¶”ê°€ ìš”ì²­ (ì„ íƒ)', required: false, textarea: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['í•´ì‹œíƒœê·¸ í¬í•¨', 'ì´ëª¨ì§€ ì‚¬ìš©', 'ì¹œê·¼í•œ í†¤', 'ì „ë¬¸ì ì¸ í†¤', 'ì§§ê³  ì„íŒ©íŠ¸ ìˆê²Œ', 'ìŠ¤í† ë¦¬í…”ë§ í˜•ì‹'],
      },
    ]
  },
};

// â•â• State â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let token = localStorage.getItem('clinote_token') || '';
let currentScreen = 'login';
let currentUser = null;
let prevScreen = 'reply';
let lastRating = null;
let currentReplyText = '';
let lastReviewText = '';
let currentClinic = null;
let isGenerating = false;
let selectedTmplType = null;
let currentTmplText = '';
let emphasisList = [];
let forbiddenWords = [];
let currentSpecialty = 'ì¹˜ê³¼';

// â•â• Env settings â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadEnvSettings() {
  if (currentUser) {
    document.getElementById('env-nickname').textContent = currentUser.nickname || 'ì‚¬ìš©ì';
    const avatar = document.getElementById('env-avatar');
    if (currentUser.profile_image) {
      avatar.innerHTML = `<img src="${currentUser.profile_image}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
    } else {
      avatar.textContent = (currentUser.nickname || '?').charAt(0).toUpperCase();
    }
  }
  loadSubscriptionStatus();
}

async function loadSubscriptionStatus() {
  try {
    const sub = await api('GET', '/api/subscription');
    const badge = document.getElementById('sub-plan-badge');
    const trialRow = document.getElementById('sub-trial-row');
    const trialText = document.getElementById('sub-trial-text');
    const planMap = { free: 'ë¬´ë£Œ', beta: 'ë² íƒ€ ë¬´ë£Œ', pro: 'Pro êµ¬ë…ì¤‘' };
    const colorMap = {
      free: 'background:#f5f5f5;color:#666',
      beta: 'background:#e8f4fd;color:#1a6fb5',
      pro: 'background:#111;color:#fff',
    };
    const plan = sub.plan || 'free';
    badge.textContent = (planMap[plan] || plan) + (sub.is_active && plan !== 'free' ? ' âœ“' : '');
    badge.style.cssText = `font-size:12px;font-weight:700;padding:3px 8px;border-radius:20px;${colorMap[plan] || colorMap.free}`;

    const usageRow = document.getElementById('sub-usage-row');
    const usageText = document.getElementById('sub-usage-text');
    const trialBadge = document.getElementById('trial-badge');
    const trialBadgeText = document.getElementById('trial-badge-text');

    if (!sub.is_active && sub.trial_ends_at) {
      const days = Math.ceil((new Date(sub.trial_ends_at) - new Date()) / 86400000);
      const used = sub.trial_count || 0;
      const remaining = Math.max(0, 30 - used);
      const expired = days <= 0;
      const exhausted = remaining === 0;

      // ê¸°ê°„ í–‰
      if (expired) {
        trialText.textContent = 'ì²´í—˜ ê¸°ê°„ ì¢…ë£Œ';
        trialText.style.color = '#e53e3e';
      } else {
        trialText.textContent = `D-${days}ì¼ ë‚¨ìŒ`;
        trialText.style.color = days <= 3 ? '#dd6b20' : 'var(--text2)';
      }
      trialRow.style.display = 'flex';

      // ì‚¬ìš©ëŸ‰ í–‰
      usageText.textContent = `${used} / 30ê±´ ì‚¬ìš©${exhausted ? ' (ì†Œì§„)' : ''}`;
      usageText.style.color = exhausted ? '#e53e3e' : (remaining <= 5 ? '#dd6b20' : 'var(--text2)');
      usageRow.style.display = 'flex';

      // í—¤ë” ë±ƒì§€ â€” 10ê±´ ì´í•˜ ë‚¨ì„ ë•Œë§Œ í‘œì‹œ
      if (trialBadge) {
        if (expired || exhausted) {
          trialBadgeText.textContent = expired ? 'ê¸°ê°„ ì¢…ë£Œ' : 'íšŸìˆ˜ ì†Œì§„';
          trialBadge.classList.add('danger');
          trialBadge.style.display = 'flex';
        } else if (remaining <= 10) {
          trialBadgeText.textContent = `${remaining}ê±´ ë‚¨ìŒ`;
          trialBadge.classList.remove('danger');
          trialBadge.style.display = 'flex';
        } else {
          trialBadge.style.display = 'none';
        }
      }

    } else if (!sub.is_active && !sub.trial_ends_at) {
      trialText.textContent = '14ì¼ / 30ê±´ ë¬´ë£Œ ì²´í—˜ ê°€ëŠ¥';
      trialText.style.color = 'var(--accent)';
      trialRow.style.display = 'flex';
      if (usageRow) usageRow.style.display = 'none';
      if (trialBadge) trialBadge.style.display = 'none';
    } else {
      if (usageRow) usageRow.style.display = 'none';
      if (trialBadge) trialBadge.style.display = 'none';
    }
  } catch(e) {}
}

async function clearAllHistory() {
  if (!confirm('ì „ì²´ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œ í›„ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
  try {
    await Promise.all([
      api('DELETE', '/api/reviews/all'),
      api('DELETE', '/api/templates/all'),
    ]);
    toast('ì „ì²´ ì´ë ¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  } catch (e) {
    toast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
  }
}

function showNotices() {
  document.getElementById('notice-modal').style.display = 'block';
}
function closeNotices() {
  document.getElementById('notice-modal').style.display = 'none';
}

async function deleteAccount() {
  if (!confirm('ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.')) return;
  try { await api('DELETE', '/api/account'); } catch {}
  localStorage.removeItem('clinote_token');
  token = '';
  currentUser = null;
  document.getElementById('bottom-nav').classList.remove('visible');
  showScreen('login');
}

// â•â• Utilities â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(method, path, body = null, isFormData = false) {
  const opts = { method, headers: { 'Authorization': `Bearer ${token}` } };
  if (body !== null) {
    if (isFormData) {
      // FormData: let browser set Content-Type with boundary
      opts.body = body;
    } else {
      opts.headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(body);
    }
  }
  const r = await fetch(path, opts);
  if (r.status === 401) {
    isGenerating = false;
    localStorage.removeItem('clinote_token');
    token = '';
    currentUser = null;
    currentClinic = null;
    document.getElementById('bottom-nav').classList.remove('visible');
    showScreen('login');
    toast('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”');
    throw new Error('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
  if (!r.ok) {
    const text = await r.text();
    let msg = text;
    try { msg = JSON.parse(text).detail || text; } catch {}
    throw new Error(msg);
  }
  return r.json();
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showScreen(name) {
  if (isGenerating && name !== currentScreen) {
    toast('ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”');
    return;
  }
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');

  // Mobile bottom nav
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const nb = document.getElementById(`nav-${name}`);
  if (nb) nb.classList.add('active');

  // Desktop sidebar
  document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
  const sb = document.getElementById(`sidebar-${name}`);
  if (sb) sb.classList.add('active');

  currentScreen = name;
  if (name === 'history') loadHistory();
  if (name === 'clinic') loadSettings();
  if (name === 'template') loadTmplClinicHeader();
}

function showEnvSettings() {
  prevScreen = currentScreen;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-env').classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  currentScreen = 'env';
  loadEnvSettings();
}

function goBack() {
  showScreen(prevScreen);
  document.getElementById('bottom-nav').classList.add('visible');
}

// â•â• Auth â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doKakaoLogin() {
  window.location.href = '/api/auth/kakao';
}

async function doLogout() {
  try { await api('POST', '/api/auth/logout'); } catch {}
  localStorage.removeItem('clinote_token');
  token = '';
  currentUser = null;
  document.getElementById('bottom-nav').classList.remove('visible');
  showScreen('login');
}

async function afterLogin() {
  // Show mobile nav
  document.getElementById('bottom-nav').classList.add('visible');

  // Show desktop sidebar (only on desktop)
  const sidebar = document.getElementById('sidebar');
  if (sidebar && window.innerWidth >= 1024) {
    sidebar.style.display = 'flex';

    // Force logo size
    const logo = document.querySelector('.sidebar-logo');
    if (logo) {
      logo.style.width = '300px';
      logo.style.height = 'auto';
    }
  }

  try { currentUser = await api('GET', '/api/me'); } catch {}
  showScreen('reply');
  try {
    const clinic = await api('GET', '/api/clinic');
    currentClinic = clinic;
    currentSpecialty = clinic.specialty || 'ì¹˜ê³¼';
    updateClinicHeader(clinic);
    if (!clinic.name) showScreen('clinic');
  } catch {}
  showPromoIfNeeded();
}

// â•â• Promo Popup â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showPromoIfNeeded() {
  try {
    const res = await api('GET', '/api/popup');
    if (!res?.active || !res?.image_url) return;
    document.getElementById('promo-img').src = res.image_url;
    const link = document.getElementById('promo-link');
    link.href = res.link_url || '#';
    link.style.pointerEvents = res.link_url ? 'auto' : 'none';
    const caption = document.getElementById('promo-caption');
    if (res.title) {
      caption.textContent = res.title;
      caption.classList.add('show');
    } else {
      caption.classList.remove('show');
    }
    document.getElementById('promo-modal').classList.add('show');
  } catch(e) {}
}
function closePromo() {
  document.getElementById('promo-modal').classList.remove('show');
}

function updateClinicHeader(clinic) {
  const name = clinic.name ? `${clinic.name} ${clinic.specialty}` : '';
  document.getElementById('clinic-name-header').textContent = name;
}

async function loadTmplClinicHeader() {
  try {
    const clinic = await api('GET', '/api/clinic');
    currentSpecialty = clinic.specialty || 'ì¹˜ê³¼';
    const el = document.getElementById('tmpl-clinic-header');
    if (el) el.textContent = clinic.name ? `${clinic.name}` : '';
  } catch {}
}

// â•â• Reply screen â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onReviewInput() {
  const val = document.getElementById('review-input').value;
  document.getElementById('generate-btn').disabled = val.trim().length < 5;
  const cc = document.getElementById('review-char');
  cc.textContent = `${val.length}ì`;
  cc.className = 'char-count' + (val.length > 500 ? ' warn' : '');
}

async function generateReply() {
  const reviewText = document.getElementById('review-input').value.trim();
  if (!reviewText) return;
  if (!currentClinic?.name) {
    toast('ë¨¼ì € ë³‘ì›ì •ë³´ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”');
    showScreen('clinic');
    return;
  }
  lastReviewText = reviewText;
  await _doGenerateReply(reviewText);
}

async function regenerateReply() {
  if (!lastReviewText) return;
  await _doGenerateReply(lastReviewText);
}

async function _doGenerateReply(reviewText) {
  const btn = document.getElementById('generate-btn');
  const btnContent = document.getElementById('generate-btn-content');
  const regenBtn = document.getElementById('regen-btn');
  const outputEl = document.getElementById('reply-output');
  const copyRow = document.getElementById('copy-row');
  const replyChar = document.getElementById('reply-char');

  isGenerating = true;
  btn.disabled = true;
  if (regenBtn) regenBtn.disabled = true;
  document.getElementById('generate-spinner').style.display = 'inline-block';
  btnContent.style.display = 'none';
  outputEl.textContent = '';
  outputEl.classList.remove('empty');
  copyRow.style.display = 'none';
  currentReplyText = '';

  try {
    const r = await fetch('/api/review/generate', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ original_text: reviewText }),
    });
    if (!r.ok) {
      const err = await r.json().catch(() => ({}));
      const msg = err.detail || 'ìƒì„± ì‹¤íŒ¨';
      outputEl.textContent = msg;
      outputEl.classList.add('empty');
      if (r.status === 403) loadSubscriptionStatus();
      return;
    }
    await _readStream(r, chunk => {
      currentReplyText += chunk;
      outputEl.textContent = currentReplyText;
      replyChar.textContent = `${currentReplyText.length}ì`;
    }, () => {
      copyRow.style.display = 'flex';
      outputEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      loadSubscriptionStatus();
    }, err => {
      outputEl.textContent = 'ì˜¤ë¥˜: ' + err;
      outputEl.classList.add('empty');
    });
  } catch (e) {
    outputEl.textContent = 'ì˜¤ë¥˜: ' + e.message;
    outputEl.classList.add('empty');
  } finally {
    isGenerating = false;
    btn.disabled = false;
    if (regenBtn) regenBtn.disabled = false;
    document.getElementById('generate-spinner').style.display = 'none';
    btnContent.style.display = '';
    btnContent.textContent = 'ë‹µë³€ ìƒì„±';
    onReviewInput();
  }
}

function copyReply() {
  if (!currentReplyText) return;
  navigator.clipboard.writeText(currentReplyText).then(() => toast('ë‹µë³€ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“'));
}

async function shareReply() {
  if (!currentReplyText) return;
  if (navigator.share) {
    try {
      await navigator.share({ text: currentReplyText });
    } catch (e) {
      if (e.name !== 'AbortError') copyReply();
    }
  } else {
    copyReply();
    toast('ê³µìœ ê°€ ì§€ì›ë˜ì§€ ì•Šì•„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤');
  }
}

async function shareTmpl() {
  const text = document.getElementById('tmpl-output').textContent;
  if (!text || text === 'ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤') return;
  if (navigator.share) {
    try {
      await navigator.share({ text });
    } catch (e) {
      if (e.name !== 'AbortError') {
        navigator.clipboard.writeText(text).then(() => toast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“'));
      }
    }
  } else {
    navigator.clipboard.writeText(text).then(() => toast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“'));
    toast('ê³µìœ ê°€ ì§€ì›ë˜ì§€ ì•Šì•„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤');
  }
}

function resetForm() {
  document.getElementById('review-input').value = '';
  document.getElementById('reply-output').textContent = 'ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤';
  document.getElementById('reply-output').classList.add('empty');
  document.getElementById('copy-row').style.display = 'none';
  document.getElementById('reply-char').textContent = '';
  document.getElementById('review-char').textContent = '0ì';
  lastReviewText = '';
  lastRating = null;
  currentReplyText = '';
  onReviewInput();
}

// â”€â”€ Desktop versions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onReviewInputDesktop() {
  const val = document.getElementById('review-input-desktop').value;
  document.getElementById('generate-btn-desktop').disabled = val.trim().length < 5;
  const cc = document.getElementById('review-char-desktop');
  cc.textContent = `${val.length}ì`;
  cc.className = 'char-count' + (val.length > 500 ? ' warn' : '');

  // Sync to mobile
  document.getElementById('review-input').value = val;
  onReviewInput();
}

async function generateReplyDesktop() {
  const reviewText = document.getElementById('review-input-desktop').value.trim();
  if (!reviewText) return;
  if (!currentClinic?.name) {
    toast('ë¨¼ì € ë³‘ì›ì •ë³´ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”');
    showScreen('clinic');
    return;
  }
  lastReviewText = reviewText;
  await _doGenerateReplyDesktop(reviewText);
}

async function regenerateReplyDesktop() {
  if (!lastReviewText) return;
  await _doGenerateReplyDesktop(lastReviewText);
}

async function _doGenerateReplyDesktop(reviewText) {
  const btn = document.getElementById('generate-btn-desktop');
  const btnContent = document.getElementById('generate-btn-content-desktop');
  const regenBtn = document.getElementById('regen-btn-desktop');
  const outputEl = document.getElementById('reply-output-desktop');
  const actions = document.getElementById('desktop-actions');
  const replyChar = document.getElementById('reply-char-desktop');

  isGenerating = true;
  btn.disabled = true;
  if (regenBtn) regenBtn.disabled = true;
  document.getElementById('generate-spinner-desktop').style.display = 'inline-block';
  btnContent.style.display = 'none';
  outputEl.textContent = '';
  outputEl.classList.remove('empty');
  actions.style.display = 'none';
  currentReplyText = '';

  try {
    const r = await fetch('/api/review/generate', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ original_text: reviewText }),
    });
    if (!r.ok) {
      const err = await r.json().catch(() => ({}));
      const msg = err.detail || 'ìƒì„± ì‹¤íŒ¨';
      outputEl.textContent = msg;
      outputEl.classList.add('empty');
      if (r.status === 403) loadSubscriptionStatus();
      return;
    }
    await _readStream(r, chunk => {
      currentReplyText += chunk;
      outputEl.textContent = currentReplyText;
      replyChar.textContent = `${currentReplyText.length}ì`;
    }, () => {
      actions.style.display = 'flex';
      loadSubscriptionStatus();
    }, err => {
      outputEl.textContent = 'ì˜¤ë¥˜: ' + err;
      outputEl.classList.add('empty');
    });
  } catch (e) {
    outputEl.textContent = 'ì˜¤ë¥˜: ' + e.message;
    outputEl.classList.add('empty');
  } finally {
    isGenerating = false;
    btn.disabled = false;
    if (regenBtn) regenBtn.disabled = false;
    document.getElementById('generate-spinner-desktop').style.display = 'none';
    btnContent.style.display = '';
    btnContent.textContent = 'ë‹µë³€ ìƒì„±';
    onReviewInputDesktop();
  }
}

function copyReplyDesktop() {
  if (!currentReplyText) return;
  navigator.clipboard.writeText(currentReplyText).then(() => toast('ë‹µë³€ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“'));
}

function resetFormDesktop() {
  document.getElementById('review-input-desktop').value = '';
  document.getElementById('reply-output-desktop').textContent = 'ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤';
  document.getElementById('reply-output-desktop').classList.add('empty');
  document.getElementById('desktop-actions').style.display = 'none';
  document.getElementById('reply-char-desktop').textContent = '';
  document.getElementById('review-char-desktop').textContent = '0ì';
  lastReviewText = '';
  currentReplyText = '';
  onReviewInputDesktop();
}

// â•â• SSE stream helper â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function _readStream(response, onChunk, onDone, onError) {
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop();
    for (const line of lines) {
      if (!line.startsWith('data: ')) continue;
      try {
        const d = JSON.parse(line.slice(6));
        if (d.chunk) onChunk(d.chunk);
        if (d.done) onDone();
        if (d.error) onError(d.error);
      } catch {}
    }
  }
}

// â•â• Template screen â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectTemplate(type) {
  selectedTmplType = type;
  document.querySelectorAll('.tmpl-card').forEach(c => c.classList.toggle('selected', c.dataset.type === type));

  const tmpl = TEMPLATES[type];
  if (!tmpl) return;

  const fieldsEl = document.getElementById('tmpl-fields');
  fieldsEl.innerHTML = tmpl.fields.map(f => {
    // Resolve chips (specialty-aware)
    let chips = f.chips;
    if (chips && typeof chips === 'object' && !Array.isArray(chips)) {
      chips = chips[currentSpecialty] || chips['default'] || [];
    }
    chips = chips || [];

    const chipsHtml = chips.length ? `
      <div class="chip-group">${chips.map(c => `<div class="chip" onclick="tmplChipClick(this,'tf-${f.id}')">${escapeHtml(c)}</div>`).join('')}</div>
    ` : '';

    const inputHtml = f.textarea
      ? `<textarea id="tf-${f.id}" placeholder="${f.placeholder}" rows="3"></textarea>`
      : `<input type="text" id="tf-${f.id}" placeholder="${f.placeholder}">`;

    return `<div class="form-group">
      <label>${f.label}${f.required ? ' *' : ''}</label>
      ${chipsHtml}
      ${inputHtml}
    </div>`;
  }).join('');

  // Reset output
  document.getElementById('tmpl-output').textContent = 'ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤';
  document.getElementById('tmpl-output').classList.add('empty');
  document.getElementById('tmpl-copy-row').style.display = 'none';
  document.getElementById('tmpl-char').textContent = '';
  currentTmplText = '';

  const paramsEl = document.getElementById('tmpl-params');
  paramsEl.classList.add('visible');
  paramsEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function tmplChipClick(chipEl, inputId) {
  const inputEl = document.getElementById(inputId);
  if (!inputEl) return;
  const val = chipEl.textContent.trim();
  const cur = inputEl.value.trim();
  // Toggle: if already in input, remove; else append
  if (cur.includes(val)) {
    inputEl.value = cur.replace(val, '').replace(/,\s*,/g, ',').replace(/^,\s*|,\s*$/g, '').trim();
    chipEl.classList.remove('selected');
  } else {
    inputEl.value = cur ? `${cur}, ${val}` : val;
    chipEl.classList.add('selected');
  }
}

async function generateTemplate() {
  if (!selectedTmplType) return;
  if (!currentClinic?.name) {
    toast('ë¨¼ì € ë³‘ì›ì •ë³´ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”');
    showScreen('clinic');
    return;
  }
  const tmpl = TEMPLATES[selectedTmplType];
  const params = {};
  let valid = true;
  for (const f of tmpl.fields) {
    const el = document.getElementById(`tf-${f.id}`);
    const val = el ? el.value.trim() : '';
    if (f.required && !val) {
      el && el.focus();
      toast(`${f.label}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”`);
      valid = false;
      break;
    }
    params[f.id] = val;
  }
  if (!valid) return;
  await _doGenerateTemplate(selectedTmplType, params);
}

async function regenTemplate() {
  if (!selectedTmplType) return;
  const tmpl = TEMPLATES[selectedTmplType];
  const params = {};
  for (const f of tmpl.fields) {
    const el = document.getElementById(`tf-${f.id}`);
    params[f.id] = el ? el.value.trim() : '';
  }
  await _doGenerateTemplate(selectedTmplType, params);
}

async function _doGenerateTemplate(type, params) {
  const btn = document.getElementById('tmpl-generate-btn');
  const btnText = document.getElementById('tmpl-generate-text');
  const outputEl = document.getElementById('tmpl-output');
  const copyRow = document.getElementById('tmpl-copy-row');
  const charEl = document.getElementById('tmpl-char');

  isGenerating = true;
  btn.disabled = true;
  document.getElementById('tmpl-spinner').style.display = 'inline-block';
  btnText.style.display = 'none';
  outputEl.textContent = '';
  outputEl.classList.remove('empty');
  copyRow.style.display = 'none';
  currentTmplText = '';

  try {
    const r = await fetch('/api/template/generate', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ template_type: type, params }),
    });
    if (!r.ok) {
      const err = await r.json().catch(() => ({}));
      const msg = err.detail || 'ìƒì„± ì‹¤íŒ¨';
      outputEl.textContent = msg;
      outputEl.classList.add('empty');
      if (r.status === 403) loadSubscriptionStatus();
      return;
    }
    await _readStream(r, chunk => {
      currentTmplText += chunk;
      outputEl.textContent = currentTmplText;
      charEl.textContent = `${currentTmplText.length}ì`;
    }, () => {
      copyRow.style.display = 'flex';
      outputEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      loadSubscriptionStatus();
    }, err => {
      outputEl.textContent = 'ì˜¤ë¥˜: ' + err;
      outputEl.classList.add('empty');
    });
  } catch (e) {
    outputEl.textContent = 'ì˜¤ë¥˜: ' + e.message;
    outputEl.classList.add('empty');
  } finally {
    isGenerating = false;
    btn.disabled = false;
    document.getElementById('tmpl-spinner').style.display = 'none';
    btnText.style.display = '';
    btnText.textContent = 'ìƒì„±í•˜ê¸°';
  }
}

function copyTmpl() {
  if (!currentTmplText) return;
  navigator.clipboard.writeText(currentTmplText).then(() => toast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“'));
}

// â•â• Template Batch (CSV) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchTemplateTab(tab) {
  document.querySelectorAll('#screen-template .filter-tab').forEach(t => t.classList.remove('active'));
  if (tab === 'single') {
    document.getElementById('tmpl-tab-single').classList.add('active');
    document.getElementById('tmpl-single-tab').style.display = '';
    document.getElementById('tmpl-batch-tab').style.display = 'none';
  } else {
    document.getElementById('tmpl-tab-batch').classList.add('active');
    document.getElementById('tmpl-single-tab').style.display = 'none';
    document.getElementById('tmpl-batch-tab').style.display = '';
  }
}

// â•â• CSV Batch â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function previewCSV() {
  const fileInput = document.getElementById('batch-csv-file');
  const previewDiv = document.getElementById('csv-preview');
  const previewTable = document.getElementById('csv-preview-table');
  const rowCount = document.getElementById('csv-row-count');

  if (!fileInput.files || !fileInput.files[0]) {
    if (previewDiv) previewDiv.style.display = 'none';
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = (e) => {
    const text = e.target.result;
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const rows = lines.slice(1, 6); // First 5 rows

    let html = '<thead><tr>';
    headers.forEach(h => {
      html += `<th>${escapeHtml(h)}</th>`;
    });
    html += '</tr></thead><tbody>';

    rows.forEach(row => {
      const cols = row.split(',').map(c => c.trim());
      html += '<tr>';
      cols.forEach(col => {
        html += `<td>${escapeHtml(col)}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody>';

    if (previewTable) previewTable.innerHTML = html;
    if (rowCount) rowCount.textContent = lines.length - 1; // excluding header
    if (previewDiv) previewDiv.style.display = 'block';
  };

  reader.readAsText(file, 'UTF-8');
}

async function batchGenerate() {
  const fileInput = document.getElementById('batch-csv-file');
  const templateType = document.getElementById('batch-template-type').value;
  const sendSms = document.getElementById('batch-send-sms').checked;
  const spinner = document.getElementById('batch-spinner');
  const btnText = document.getElementById('batch-btn-text');
  const resultsDiv = document.getElementById('batch-results');
  const resultsListDiv = document.getElementById('batch-results-list');

  if (!fileInput.files || !fileInput.files[0]) {
    alert('CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
    return;
  }

  const file = fileInput.files[0];
  const formData = new FormData();
  formData.append('file', file);
  formData.append('template_type', templateType);
  formData.append('send_sms', sendSms);

  spinner.style.display = '';
  btnText.textContent = 'ìƒì„± ì¤‘...';

  try {
    const r = await api('POST', '/api/template/batch-generate', formData, true); // true = FormData

    if (!r || !r.results) {
      throw new Error('ìƒì„± ì‹¤íŒ¨');
    }

    // Display results
    resultsDiv.style.display = '';
    let html = '';

    if (r.sms && r.sms.success > 0) {
      html += `<div style="padding: 12px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; margin-bottom: 16px; font-size: 14px; color: #166534;">
        âœ… SMS ë°œì†¡ ì™„ë£Œ: ${r.sms.success}ê±´ ì„±ê³µ, ${r.sms.failed}ê±´ ì‹¤íŒ¨
      </div>`;
    }

    r.results.forEach(item => {
      const phoneDisplay = item.phone || 'ì „í™”ë²ˆí˜¸ ì—†ìŒ';
      html += `
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div>
              <strong style="font-size: 15px;">${item.index}. ${item.name}</strong>
              <div style="font-size: 13px; color: var(--text2); margin-top: 4px;">${phoneDisplay}</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="copyBatchMessage(\`${item.message.replace(/`/g, '\\`')}\`)">ë³µì‚¬</button>
          </div>
          <div style="background: var(--card2); padding: 12px; border-radius: 6px; font-size: 14px; line-height: 1.6; white-space: pre-wrap;">${item.message}</div>
        </div>
      `;
    });

    resultsListDiv.innerHTML = html;

    // Desktop: render table
    renderBatchResultsTable(r.results);

    loadSubscriptionStatus();

  } catch (e) {
    alert('ì˜¤ë¥˜: ' + (e.message || 'ì¼ê´„ ìƒì„± ì‹¤íŒ¨'));
  } finally {
    spinner.style.display = 'none';
    btnText.textContent = 'ì¼ê´„ ìƒì„±í•˜ê¸°';
  }
}

function renderBatchResultsTable(results) {
  const tbody = document.getElementById('batch-results-tbody');
  const container = document.getElementById('batch-results-table-container');
  const empty = document.getElementById('batch-results-empty');

  if (!tbody) return;

  if (!results || !results.length) {
    if (container) container.style.display = 'none';
    if (empty) empty.style.display = 'block';
    return;
  }

  tbody.innerHTML = results.map((item, idx) => `
    <tr>
      <td>${item.index || idx + 1}</td>
      <td>${escapeHtml(item.name || '-')}</td>
      <td>${escapeHtml(item.phone || '-')}</td>
      <td style="max-width: 400px; white-space: pre-wrap;">${escapeHtml(item.message.substring(0, 100))}${item.message.length > 100 ? '...' : ''}</td>
      <td>
        <button class="btn btn-secondary btn-sm" onclick="copyBatchMessage(\`${item.message.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">ë³µì‚¬</button>
      </td>
    </tr>
  `).join('');

  if (container) container.style.display = 'block';
  if (empty) empty.style.display = 'none';
}

async function batchGenerateMobile() {
  // Wrapper for mobile - use mobile-specific IDs
  const fileInput = document.getElementById('batch-csv-file-mobile');
  const templateType = document.getElementById('batch-template-type-mobile').value;
  const sendSms = document.getElementById('batch-send-sms-mobile').checked;
  const spinner = document.getElementById('batch-spinner-mobile');

  if (!fileInput.files || !fileInput.files[0]) {
    alert('CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
    return;
  }

  const file = fileInput.files[0];
  const formData = new FormData();
  formData.append('file', file);
  formData.append('template_type', templateType);
  formData.append('send_sms', sendSms);

  spinner.style.display = '';

  try {
    const r = await api('POST', '/api/template/batch-generate', formData, true);

    if (!r || !r.results) {
      throw new Error('ìƒì„± ì‹¤íŒ¨');
    }

    const resultsDiv = document.getElementById('batch-results');
    const resultsListDiv = document.getElementById('batch-results-list');

    resultsDiv.style.display = '';
    let html = '';

    if (r.sms && r.sms.success > 0) {
      html += `<div style="padding: 12px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; margin-bottom: 16px; font-size: 14px; color: #166534;">
        âœ… SMS ë°œì†¡ ì™„ë£Œ: ${r.sms.success}ê±´ ì„±ê³µ, ${r.sms.failed}ê±´ ì‹¤íŒ¨
      </div>`;
    }

    r.results.forEach(item => {
      const phoneDisplay = item.phone || 'ì „í™”ë²ˆí˜¸ ì—†ìŒ';
      html += `
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div>
              <strong style="font-size: 15px;">${item.index}. ${item.name}</strong>
              <div style="font-size: 13px; color: var(--text2); margin-top: 4px;">${phoneDisplay}</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="copyBatchMessage(\`${item.message.replace(/`/g, '\\`')}\`)">ë³µì‚¬</button>
          </div>
          <div style="background: var(--card2); padding: 12px; border-radius: 6px; font-size: 14px; line-height: 1.6; white-space: pre-wrap;">${item.message}</div>
        </div>
      `;
    });

    resultsListDiv.innerHTML = html;
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    loadSubscriptionStatus();

  } catch (e) {
    alert('ì˜¤ë¥˜: ' + (e.message || 'ì¼ê´„ ìƒì„± ì‹¤íŒ¨'));
  } finally {
    spinner.style.display = 'none';
  }
}

function copyBatchMessage(text) {
  navigator.clipboard.writeText(text).then(() => toast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“'));
}

// â•â• History â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _historyFilter = 'all';
let _historyCache = [];

function setHistoryFilter(type) {
  _historyFilter = type;
  // Update mobile filter tabs
  document.querySelectorAll('#screen-history .mobile-only .filter-tab').forEach(t => t.classList.remove('active'));
  const mobileTab = document.getElementById('filter-' + type);
  if (mobileTab) mobileTab.classList.add('active');

  // Update desktop filter tabs
  document.querySelectorAll('#screen-history .desktop-only .filter-tab').forEach(t => t.classList.remove('active'));
  const desktopTab = document.getElementById('filter-' + type + '-desktop');
  if (desktopTab) desktopTab.classList.add('active');

  renderHistoryList();
}

function renderHistoryList() {
  // Apply search filter
  const searchTerm = document.getElementById('history-search')?.value.toLowerCase() || '';
  let filtered = _historyCache.filter(item => {
    if (!searchTerm) return true;
    const original = (item.original_text || '').toLowerCase();
    const result = (item.reply_text || item.output_text || '').toLowerCase();
    return original.includes(searchTerm) || result.includes(searchTerm);
  });

  // Apply type filter
  if (_historyFilter !== 'all') {
    filtered = filtered.filter(item => item._type === _historyFilter);
  }

  // Apply sorting
  const sortBy = document.getElementById('history-sort')?.value || 'date_desc';
  if (sortBy === 'date_asc') {
    filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
  } else {
    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  }

  // Render mobile cards
  renderHistoryCards(filtered);

  // Render desktop table
  renderHistoryTable(filtered);
}

function renderHistoryCards(items) {
  const cardsEl = document.getElementById('history-cards');
  if (!cardsEl) return;

  if (!items.length) {
    cardsEl.innerHTML = '<div class="empty-state"><div class="emoji">ğŸ“‹</div>í•´ë‹¹í•˜ëŠ” ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }

  cardsEl.innerHTML = items.map(item => {
    const date = item.created_at ? item.created_at.substring(0, 16) : '';
    if (item._type === 'review') {
      const stars = item.rating ? 'â˜…'.repeat(item.rating) + 'â˜†'.repeat(5 - item.rating) : '';
      const platformLabel = { naver: 'ë„¤ì´ë²„', kakao: 'ì¹´ì¹´ì˜¤', google: 'êµ¬ê¸€' }[item.platform] || item.platform;
      return `<div class="history-card">
        <div class="meta">
          <span class="platform-badge">ë¦¬ë·° ë‹µë³€</span>
          <span class="platform-badge">${platformLabel}</span>
          ${stars ? `<span class="rating-stars">${stars}</span>` : ''}
          <span class="history-date">${date}</span>
        </div>
        <div class="history-review">${escapeHtml(item.original_text.substring(0, 100))}${item.original_text.length > 100 ? '...' : ''}</div>
        <div class="history-reply">${escapeHtml(item.reply_text)}</div>
        <div class="history-actions">
          <button class="btn btn-secondary btn-sm copy-btn" data-text="${escapeHtml(item.reply_text)}">ë³µì‚¬</button>
          <button class="btn btn-danger btn-sm" onclick="deleteReview(${item.id}, this)">ì‚­ì œ</button>
        </div>
      </div>`;
    } else {
      const paramsStr = Object.values(item.params || {}).filter(Boolean).join(' Â· ');
      return `<div class="history-card">
        <div class="meta">
          <span class="platform-badge">ë¬¸ìÂ·ê³µì§€</span>
          <span class="platform-badge">${escapeHtml(item.label || item.template_type)}</span>
          <span class="history-date">${date}</span>
        </div>
        ${paramsStr ? `<div class="history-review">${escapeHtml(paramsStr.substring(0, 80))}</div>` : ''}
        <div class="history-reply">${escapeHtml(item.output_text)}</div>
        <div class="history-actions">
          <button class="btn btn-secondary btn-sm copy-btn" data-text="${escapeHtml(item.output_text)}">ë³µì‚¬</button>
          <button class="btn btn-danger btn-sm" onclick="deleteTemplate(${item.id}, this)">ì‚­ì œ</button>
        </div>
      </div>`;
    }
  }).join('');

  // ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸
  cardsEl.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => copyText(btn.dataset.text));
  });
}

function renderHistoryTable(items) {
  const tbody = document.getElementById('history-table-body');
  if (!tbody) return;

  if (!items.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:48px;color:var(--text2)">í•´ë‹¹í•˜ëŠ” ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    return;
  }

  tbody.innerHTML = items.map(item => {
    const type = item._type === 'review' ? 'review' : 'template';
    const typeLabel = type === 'review' ? 'ë¦¬ë·°' : 'ë¬¸ì';
    const result = item.reply_text || item.output_text || '';
    const original = item.original_text || Object.values(item.params || {}).filter(Boolean).join(' Â· ') || '-';
    const date = new Date(item.created_at).toLocaleString('ko-KR', {
      month: 'numeric', day: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });

    return `
      <tr>
        <td><span class="type-badge ${type}">${typeLabel}</span></td>
        <td>${date}</td>
        <td>${escapeHtml(original.substring(0, 50))}${original.length > 50 ? '...' : ''}</td>
        <td>${escapeHtml(result.substring(0, 80))}${result.length > 80 ? '...' : ''}</td>
        <td>${result.length}ì</td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="copyText(\`${result.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">ë³µì‚¬</button>
          <button class="btn btn-danger btn-sm" onclick="${type === 'review' ? 'deleteReview' : 'deleteTemplate'}(${item.id}, this)">ì‚­ì œ</button>
        </td>
      </tr>
    `;
  }).join('');
}

function filterHistory() {
  renderHistoryList();
}

function sortHistory() {
  renderHistoryList();
}

async function loadHistory() {
  const cardsEl = document.getElementById('history-cards');
  const tbody = document.getElementById('history-table-body');
  if (cardsEl) cardsEl.innerHTML = '<div class="empty-state"><div class="emoji">â³</div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:48px;color:var(--text2)">â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

  try {
    const [reviewRes, tmplRes] = await Promise.all([
      api('GET', '/api/reviews?limit=50'),
      api('GET', '/api/templates?limit=50'),
    ]);
    const reviews = reviewRes.items.map(r => ({ ...r, _type: 'review' }));
    const tmpls = tmplRes.items.map(t => ({ ...t, _type: 'template' }));
    _historyCache = [...reviews, ...tmpls].sort((a, b) =>
      (b.created_at || '').localeCompare(a.created_at || '')
    );
    renderHistoryList();
  } catch (e) {
    if (cardsEl) cardsEl.innerHTML = `<div class="empty-state"><div class="emoji">âŒ</div>${e.message}</div>`;
    if (tbody) tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:48px;color:var(--text2)">âŒ ${e.message}</td></tr>`;
  }
}

async function deleteReview(id, btn) {
  btn.disabled = true;
  try {
    await api('DELETE', `/api/reviews/${id}`);
    btn.closest('.history-card').remove();
    toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  } catch (e) {
    toast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
    btn.disabled = false;
  }
}

async function deleteTemplate(id, btn) {
  btn.disabled = true;
  try {
    await api('DELETE', `/api/templates/${id}`);
    btn.closest('.history-card').remove();
    toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  } catch (e) {
    toast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
    btn.disabled = false;
  }
}

function copyText(text) {
  navigator.clipboard.writeText(text)
    .then(() => toast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“'))
    .catch(() => {
      const ta = document.createElement('textarea');
      ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
      document.body.appendChild(ta); ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      toast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
    });
}

// â•â• Settings â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSettings() {
  try {
    const clinic = await api('GET', '/api/clinic');
    document.getElementById('s-name').value = clinic.name || '';
    document.getElementById('s-specialty').value = clinic.specialty || 'ì¹˜ê³¼';
    document.getElementById('s-doctor').value = clinic.doctor_name || '';
    document.getElementById('s-tone').value = clinic.tone || 'formal';
    document.getElementById('s-phone').value = clinic.phone || '';
    document.getElementById('s-naver-map').value = clinic.naver_map_url || '';
    document.getElementById('s-instagram').value = clinic.instagram_url || '';
    document.getElementById('s-kakao-channel').value = clinic.kakao_channel || '';
    currentSpecialty = clinic.specialty || 'ì¹˜ê³¼';

    // Parse emphasis string â†’ list
    const emphStr = clinic.emphasis || '';
    emphasisList = emphStr ? emphStr.split(/,\s*/).filter(Boolean) : [];
    renderEmphasisChips();
    renderEmphasisTags();

    forbiddenWords = Array.isArray(clinic.forbidden_words) ? [...clinic.forbidden_words] : [];
    renderForbiddenTags();
  } catch {}
}

function onSpecialtyChange() {
  currentSpecialty = document.getElementById('s-specialty').value;
  renderEmphasisChips();
}

function renderEmphasisChips() {
  const opts = SPECIALTY_EMPHASIS[currentSpecialty] || SPECIALTY_EMPHASIS['ê¸°íƒ€'];
  const el = document.getElementById('emphasis-chips');
  el.innerHTML = opts.map(o => {
    const selected = emphasisList.includes(o) ? ' selected' : '';
    return `<div class="chip${selected}" onclick="toggleEmphasisChip(this, '${escapeHtml(o)}')">${escapeHtml(o)}</div>`;
  }).join('');
}

function toggleEmphasisChip(chipEl, value) {
  if (emphasisList.includes(value)) {
    emphasisList = emphasisList.filter(v => v !== value);
    chipEl.classList.remove('selected');
  } else {
    emphasisList.push(value);
    chipEl.classList.add('selected');
  }
  renderEmphasisTags();
}

function renderEmphasisTags() {
  const el = document.getElementById('emphasis-tags');
  el.innerHTML = emphasisList.map((w, i) =>
    `<div class="tag">${escapeHtml(w)}<button class="tag-remove" onclick="removeEmphasis(${i})">Ã—</button></div>`
  ).join('');
}

function addEmphasis() {
  const input = document.getElementById('s-emphasis-input');
  const word = input.value.trim();
  if (!word || emphasisList.includes(word)) { input.value = ''; return; }
  emphasisList.push(word);
  input.value = '';
  renderEmphasisTags();
  // Sync chips if it matches
  renderEmphasisChips();
}

function removeEmphasis(i) {
  emphasisList.splice(i, 1);
  renderEmphasisTags();
  renderEmphasisChips();
}

function addForbiddenChip(word) {
  if (!forbiddenWords.includes(word)) {
    forbiddenWords.push(word);
    renderForbiddenTags();
  }
}

function addForbiddenWord() {
  const input = document.getElementById('s-forbidden-input');
  const word = input.value.trim();
  if (!word || forbiddenWords.includes(word)) { input.value = ''; return; }
  forbiddenWords.push(word);
  input.value = '';
  renderForbiddenTags();
}

function removeForbiddenWord(i) {
  forbiddenWords.splice(i, 1);
  renderForbiddenTags();
}

function renderForbiddenTags() {
  const el = document.getElementById('forbidden-tags');
  el.innerHTML = forbiddenWords.map((w, i) =>
    `<div class="ftag">${escapeHtml(w)}<button class="ftag-remove" onclick="removeForbiddenWord(${i})">Ã—</button></div>`
  ).join('');
}

async function saveSettings() {
  const name = document.getElementById('s-name').value.trim();
  if (!name) { toast('ë³‘ì›ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const btnText = document.getElementById('settings-btn-text');
  btnText.textContent = 'ì €ì¥ ì¤‘...';
  try {
    const clinic = await api('PUT', '/api/clinic', {
      name,
      specialty: document.getElementById('s-specialty').value,
      doctor_name: document.getElementById('s-doctor').value.trim(),
      tone: document.getElementById('s-tone').value,
      forbidden_words: forbiddenWords,
      emphasis: emphasisList.join(', '),
      phone: document.getElementById('s-phone').value.trim(),
      naver_map_url: document.getElementById('s-naver-map').value.trim(),
      instagram_url: document.getElementById('s-instagram').value.trim(),
      kakao_channel: document.getElementById('s-kakao-channel').value.trim(),
    });
    currentClinic = clinic;
    currentSpecialty = clinic.specialty || 'ì¹˜ê³¼';
    updateClinicHeader(clinic);
    toast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
    setTimeout(() => showScreen('reply'), 800);
  } catch (e) {
    toast('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  } finally {
    btnText.textContent = 'ì„¤ì • ì €ì¥';
  }
}

// â•â• Service Worker â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/static/sw.js').catch(() => {});
  });
}

// â•â• Init â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Kakao OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬: URLì—ì„œ token / error íŒŒë¼ë¯¸í„° ìˆ˜ì‹ 
(function handleOAuthRedirect() {
  const params = new URLSearchParams(window.location.search);
  const urlToken = params.get('token');
  const urlError = params.get('error');
  if (urlToken) {
    token = urlToken;
    localStorage.setItem('clinote_token', token);
    window.history.replaceState({}, document.title, '/');
  }
  if (urlError) {
    document.getElementById('login-error').textContent = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
    window.history.replaceState({}, document.title, '/');
  }
})();

// â”€â”€ Admin entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (window.location.pathname === '/admin') {
  if (token) showAdminPanel();
  else window.location.href = '/api/auth/kakao';
} else {
  if (token) afterLogin();
}

// â•â• Admin Panel â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showAdminPanel() {
  document.getElementById('bottom-nav').classList.remove('visible');
  try {
    const me = await api('GET', '/api/me');
    currentUser = me;
  } catch {
    window.location.href = '/api/auth/kakao';
    return;
  }
  // 403ì´ë©´ ì¼ë°˜ ìœ ì €
  try {
    await api('GET', '/api/admin/stats');
  } catch(e) {
    toast('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤');
    setTimeout(() => { window.location.href = '/'; }, 1500);
    return;
  }
  document.getElementById('screen-login').classList.remove('active');
  document.getElementById('screen-admin').classList.add('active');
  loadAdminStats();
}

function switchAdminTab(tab, el) {
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.admin-pane').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('admin-pane-' + tab).classList.add('active');
  if (tab === 'stats') loadAdminStats();
  else if (tab === 'users') loadAdminUsers();
  else if (tab === 'popup') loadAdminPopup();
}

async function loadAdminStats() {
  try {
    const s = await api('GET', '/api/admin/stats');
    document.getElementById('stat-users').textContent = s.total_users;
    document.getElementById('stat-subs').textContent = s.active_subscriptions;
    document.getElementById('stat-new-today').textContent = s.new_users_today;
    document.getElementById('stat-new-month').textContent = s.new_users_month;
    document.getElementById('stat-today').textContent = s.today_generated;
    document.getElementById('stat-month').textContent = s.month_generated;
    document.getElementById('stat-total').textContent = s.total_generated;
    document.getElementById('stat-free').textContent = s.plan_free;
    document.getElementById('stat-beta').textContent = s.plan_beta;
    document.getElementById('stat-pro').textContent = s.plan_pro;
  } catch(e) {}
}

async function loadAdminUsers() {
  const list = document.getElementById('admin-user-list');
  list.innerHTML = '<div style="color:var(--text2);font-size:14px">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  try {
    const res = await api('GET', '/api/admin/users?limit=100');
    allUsers = res.items;
    renderUserList();
  } catch(e) {
    list.innerHTML = '<div style="color:red">ì˜¤ë¥˜: ' + e.message + '</div>';
  }
}

let allUsers = [];
let activePlanFilter = 'all';

function setUserFilter(btn, plan) {
  activePlanFilter = plan;
  document.querySelectorAll('.ufilter').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderUserList();
}

function filterUsers() { renderUserList(); }

function renderUserList() {
  const list = document.getElementById('admin-user-list');
  const q = (document.getElementById('user-search')?.value || '').toLowerCase();
  const planLabel = { free: 'ë¬´ë£Œ', beta: 'ë² íƒ€', pro: 'Pro' };
  const filtered = allUsers.filter(u => {
    if (activePlanFilter !== 'all' && u.plan !== activePlanFilter) return false;
    if (q && !((u.nickname || u.kakao_id) + '').toLowerCase().includes(q)) return false;
    return true;
  });
  if (!filtered.length) {
    list.innerHTML = '<div style="color:var(--text2);font-size:14px;padding:12px 0">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
    return;
  }
  list.innerHTML = filtered.map(u => `
      <div class="user-row" onclick="toggleUserForm('${u.kakao_id}')">
        <div class="user-row-top">
          <img class="user-avatar" src="${u.profile_image || ''}" onerror="this.style.display='none'">
          <div class="user-info">
            <div class="user-name">${escapeHtml(u.nickname || u.kakao_id)}</div>
            <div class="user-meta">${u.created_at ? u.created_at.substring(0,10) : ''} Â· ë¦¬ë·° ${u.review_count} Â· ë¬¸ì ${u.template_count} Â· ì²´í—˜ ${u.trial_count||0}/30ê±´</div>
          </div>
          <span class="plan-badge ${u.plan === 'pro' ? 'pro' : u.plan === 'beta' ? 'beta' : ''}">${planLabel[u.plan] || u.plan}</span>
        </div>
        <div class="user-sub-form" id="form-${u.kakao_id}" onclick="event.stopPropagation()">
          <div class="admin-field">
            <label>í”Œëœ</label>
            <select id="plan-${u.kakao_id}">
              <option value="free" ${u.plan==='free'?'selected':''}>ë¬´ë£Œ</option>
              <option value="beta" ${u.plan==='beta'?'selected':''}>ë² íƒ€ ë¬´ë£Œ</option>
              <option value="pro" ${u.plan==='pro'?'selected':''}>Pro</option>
            </select>
          </div>
          <div class="admin-field">
            <label class="admin-toggle">
              <input type="checkbox" id="active-${u.kakao_id}" style="width:auto" ${u.is_active?'checked':''}>
              êµ¬ë… í™œì„±í™”
            </label>
          </div>
          <div class="admin-field">
            <label>ì²´í—˜ ë§Œë£Œì¼</label>
            <input type="date" id="trial-${u.kakao_id}" value="${u.trial_ends_at||''}">
          </div>
          <div class="admin-field">
            <label>êµ¬ë… ë§Œë£Œì¼ <span style="font-weight:400;font-size:12px;color:var(--muted)">(ë¹„ì›Œë‘ë©´ ì˜êµ¬)</span></label>
            <input type="date" id="expires-${u.kakao_id}" value="${u.expires_at||''}">
          </div>
          <div class="admin-field">
            <label>ë©”ëª¨</label>
            <input type="text" id="memo-${u.kakao_id}" value="${escapeHtml(u.memo||'')}" placeholder="ê´€ë¦¬ì ë©”ëª¨">
          </div>
          <button onclick="saveUserSub('${u.kakao_id}', event)" style="padding:8px 16px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer">ì €ì¥</button>
        </div>
      </div>
    `).join('');
}

function toggleUserForm(kakaoId) {
  const form = document.getElementById('form-' + kakaoId);
  form.classList.toggle('open');
}

async function saveUserSub(kakaoId, e) {
  e.stopPropagation();
  const plan = document.getElementById('plan-' + kakaoId).value;
  const isActive = document.getElementById('active-' + kakaoId).checked ? 1 : 0;
  const trial = document.getElementById('trial-' + kakaoId).value.trim() || null;
  const expires = document.getElementById('expires-' + kakaoId).value.trim() || null;
  const memo = document.getElementById('memo-' + kakaoId).value.trim();
  try {
    await api('PUT', `/api/admin/users/${kakaoId}/subscription`, {
      plan, is_active: isActive, trial_ends_at: trial, expires_at: expires, memo
    });
    // allUsers ìºì‹œ ì—…ë°ì´íŠ¸
    const u = allUsers.find(x => x.kakao_id === kakaoId);
    if (u) { u.plan = plan; u.is_active = isActive; u.trial_ends_at = trial; u.expires_at = expires; u.memo = memo; }
    toast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
  } catch(err) {
    toast('ì €ì¥ ì‹¤íŒ¨: ' + err.message);
  }
}

async function loadAdminPopup() {
  try {
    const p = await api('GET', '/api/admin/popup');
    document.getElementById('popup-image-url').value = p.image_url || '';
    document.getElementById('popup-link-url').value = p.link_url || '';
    document.getElementById('popup-title').value = p.title || '';
    document.getElementById('popup-active').checked = !!p.active;
    previewPopupImg();
  } catch(e) {}
}

function previewPopupImg() {
  const url = document.getElementById('popup-image-url').value.trim();
  const preview = document.getElementById('popup-preview');
  const img = document.getElementById('popup-preview-img');
  if (url) { img.src = url; preview.style.display = 'block'; }
  else { preview.style.display = 'none'; }
}

async function saveAdminPopup() {
  const image_url = document.getElementById('popup-image-url').value.trim();
  const link_url = document.getElementById('popup-link-url').value.trim();
  const title = document.getElementById('popup-title').value.trim();
  const active = document.getElementById('popup-active').checked ? 1 : 0;
  try {
    await api('PUT', '/api/admin/popup', { image_url, link_url, title, active });
    toast('íŒì—… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
  } catch(e) {
    toast('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  }
}
</script>
</div><!-- #app -->
</body>
</html>
