<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Clinote">
<meta name="theme-color" content="#ffffff">
<link rel="manifest" href="/static/manifest.json">
<title>Clinote</title>
<style>
/* â•â• Theme variables â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --red: #ef4444;
  --yellow: #f59e0b;
  --radius: 8px;
}
[data-theme="dark"] {
  --accent: #10b981;
  --accent2: #059669;
  --bg: #0a0a0a;
  --card: #141414;
  --card2: #1e1e1e;
  --border: #2a2a2a;
  --text: #f0f0f0;
  --text2: #888888;
  --shadow: 0 4px 24px rgba(0,0,0,0.5);
  --chip-bg: #1e1e1e;
  --chip-text: #aaaaaa;
}
[data-theme="light"] {
  --accent: #111111;
  --accent2: #333333;
  --bg: #ffffff;
  --card: #ffffff;
  --card2: #f5f5f5;
  --border: #e5e5e5;
  --text: #111111;
  --text2: #767676;
  --shadow: 0 1px 8px rgba(0,0,0,0.06);
  --chip-bg: #f0f0f0;
  --chip-text: #333333;
}

/* â•â• Reset & Base â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  transition: background 0.2s, color 0.2s;
}
.screen { display: none; flex: 1; flex-direction: column; }
.screen.active { display: flex; }

/* â•â• Header â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header {
  padding: 16px 20px 14px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--bg);
  position: sticky; top: 0; z-index: 10;
  transition: background 0.2s, border-color 0.2s;
}
.header h1 { font-size: 18px; font-weight: 800; color: var(--text); flex: 1; letter-spacing: -0.5px; }
.header .subtitle { font-size: 12px; color: var(--text2); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* â•â• Theme toggle â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.theme-btn {
  background: none;
  border: 1px solid var(--border);
  border-radius: 50%;
  width: 34px; height: 34px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  font-size: 15px;
  flex-shrink: 0;
  transition: background 0.2s, border-color 0.2s;
}
.theme-btn:active { opacity: 0.6; }

/* â•â• Bottom Nav â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  display: none;
  position: sticky; bottom: 0;
  background: var(--bg);
  border-top: 1px solid var(--border);
  padding: 8px 0 max(8px, env(safe-area-inset-bottom));
  transition: background 0.2s, border-color 0.2s;
}
.bottom-nav.visible { display: flex; }
.nav-btn {
  flex: 1;
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  background: none; border: none; cursor: pointer;
  color: var(--text2); font-size: 10px; padding: 6px 0;
  transition: color 0.15s;
}
.nav-btn svg { width: 20px; height: 20px; }
.nav-btn.active { color: var(--text); }

/* â•â• Scroll area â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.scroll-area { flex: 1; overflow-y: auto; padding: 20px; }

/* â•â• Forms â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
label {
  display: block; font-size: 11px; color: var(--text2);
  margin-bottom: 6px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.8px;
}
input, textarea, select {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-size: 15px;
  padding: 12px 14px;
  font-family: inherit;
  outline: none;
  transition: border-color 0.15s;
}
input:focus, textarea:focus, select:focus { border-color: var(--text); }
[data-theme="light"] select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23111111' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
[data-theme="dark"] select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2310b981' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
textarea { resize: vertical; min-height: 80px; }
.form-group { margin-bottom: 20px; }

/* â•â• Buttons â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 14px 18px; border-radius: var(--radius); border: none;
  font-size: 15px; font-weight: 600; cursor: pointer;
  transition: opacity 0.15s, transform 0.1s;
  font-family: inherit; letter-spacing: -0.2px;
}
.btn:active { transform: scale(0.97); opacity: 0.8; }
.btn-primary { background: var(--accent); color: #fff; width: 100%; }
[data-theme="light"] .btn-primary { color: #ffffff; }
.btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
.btn-danger { background: var(--red); color: #fff; }
.btn-sm { padding: 8px 14px; font-size: 13px; }
.btn:disabled { opacity: 0.35; cursor: not-allowed; }

/* â•â• Chips (predefined options) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chip-label {
  font-size: 11px; color: var(--text2);
  font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px;
  margin-bottom: 8px; margin-top: 4px;
}
.chip-group { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
.chip {
  padding: 6px 13px; border-radius: 20px; font-size: 13px;
  background: var(--chip-bg); border: 1px solid var(--border);
  cursor: pointer; transition: all 0.15s;
  color: var(--chip-text); font-weight: 500; line-height: 1.2;
  user-select: none;
}
.chip:active { transform: scale(0.95); }
.chip.selected { background: var(--accent); color: #fff; border-color: var(--accent); }
.chip-section-title { font-size: 11px; color: var(--text2); margin: 8px 0 4px; font-weight: 600; width: 100%; }

/* â•â• Tags (added items) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tags-wrap { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; min-height: 8px; }
.tag {
  display: flex; align-items: center; gap: 4px;
  background: var(--card2); border: 1px solid var(--border);
  border-radius: 20px; padding: 4px 10px; font-size: 13px; color: var(--text);
}
.tag-remove { background: none; border: none; color: var(--text2); cursor: pointer; font-size: 16px; line-height: 1; padding: 0 2px; opacity: 0.7; }
.add-tag-row { display: flex; gap: 8px; margin-top: 8px; }
.add-tag-row input { flex: 1; }

/* Forbidden tags (different color) */
.forbidden-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.ftag {
  display: flex; align-items: center; gap: 4px;
  background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
  border-radius: 20px; padding: 4px 10px; font-size: 13px; color: var(--red);
}
.ftag-remove { background: none; border: none; color: var(--red); cursor: pointer; font-size: 16px; line-height: 1; padding: 0 2px; opacity: 0.7; }

/* â•â• Stars â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stars { display: flex; gap: 6px; }
.star-btn { background: none; border: none; cursor: pointer; font-size: 26px; color: var(--border); transition: color 0.1s; line-height: 1; }
.star-btn.active { color: var(--yellow); }

/* â•â• Platform tabs â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.platform-tabs { display: flex; gap: 6px; margin-bottom: 16px; }
.platform-tab {
  flex: 1; padding: 9px; border-radius: var(--radius); border: 1px solid var(--border);
  background: var(--bg); color: var(--text2); font-size: 13px; font-weight: 600;
  cursor: pointer; text-align: center; transition: all 0.15s;
}
.platform-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }

/* â•â• Reply output â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.reply-output {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  font-size: 15px; line-height: 1.8;
  min-height: 80px;
  white-space: pre-wrap; word-break: break-word;
  transition: background 0.2s;
}
.reply-output.empty { color: var(--text2); font-style: normal; border-color: var(--border); }
.copy-row { display: flex; gap: 8px; margin-top: 10px; }

/* â•â• History â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.history-card {
  background: var(--bg); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px; margin-bottom: 10px;
  transition: background 0.2s;
}
.history-card .meta { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
.platform-badge { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 6px; background: var(--card2); color: var(--text2); text-transform: uppercase; }
.rating-stars { color: var(--yellow); font-size: 13px; }
.history-date { font-size: 11px; color: var(--text2); margin-left: auto; }
.history-review { font-size: 13px; color: var(--text2); margin-bottom: 8px; border-left: 2px solid var(--border); padding-left: 10px; line-height: 1.5; }
.history-reply { font-size: 14px; line-height: 1.65; }
.history-actions { display: flex; gap: 8px; margin-top: 10px; justify-content: flex-end; }

/* â•â• Char count â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.char-count { font-size: 11px; color: var(--text2); text-align: right; margin-top: 4px; }
.char-count.warn { color: var(--yellow); }

/* â•â• Login â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.login-wrap {
  display: flex; flex-direction: column; align-items: flex-start; justify-content: center;
  flex: 1; padding: 48px 28px;
}
.login-logo { font-size: 48px; font-weight: 800; color: var(--text); margin-bottom: 8px; letter-spacing: -2px; }
.login-tagline { font-size: 16px; color: var(--text2); margin-bottom: 52px; line-height: 1.6; font-weight: 400; }
.login-form { width: 100%; max-width: 400px; }
.login-form input { font-size: 16px; padding: 14px; letter-spacing: 1px; }
.login-theme-btn { display: flex; align-items: center; justify-content: center; gap: 6px; background: none; border: none; color: var(--text2); font-size: 13px; cursor: pointer; margin: 20px 0 0; padding: 8px 0; }
.error-msg { color: var(--red); font-size: 13px; margin-top: 10px; min-height: 20px; }

/* â•â• Spinner â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â• Toast â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: var(--text); color: var(--bg); padding: 10px 20px; border-radius: 20px;
  font-size: 14px; font-weight: 600; opacity: 0; transition: all 0.25s; pointer-events: none;
  white-space: nowrap; z-index: 9999;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â•â• Section title â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.section-title { font-size: 11px; color: var(--text2); font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.8px; }
.settings-header { font-size: 14px; color: var(--text2); margin-bottom: 24px; line-height: 1.7; }
.empty-state { text-align: center; color: var(--text2); padding: 48px 20px; font-size: 14px; }
.empty-state .emoji { font-size: 36px; margin-bottom: 12px; }
.divider { height: 1px; background: var(--border); margin: 24px 0; }

/* â•â• Template grid â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tmpl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 24px; }
.tmpl-card {
  background: var(--card2); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px 12px;
  cursor: pointer; text-align: center; transition: all 0.15s;
}
.tmpl-card:active { transform: scale(0.97); }
.tmpl-card.selected { border-color: var(--accent); background: var(--card2); box-shadow: inset 0 0 0 1px var(--accent); }
.tmpl-card .tmpl-icon { font-size: 24px; margin-bottom: 8px; }
.tmpl-card .tmpl-name { font-size: 13px; font-weight: 600; color: var(--text); line-height: 1.3; }
.tmpl-card .tmpl-desc { font-size: 11px; color: var(--text2); margin-top: 4px; }

#tmpl-params { display: none; }
#tmpl-params.visible { display: block; }

/* â•â• History filter tabs â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.filter-tabs {
  display: flex; gap: 6px; padding: 12px 20px 0;
  background: var(--bg); border-bottom: 1px solid var(--border);
}
.filter-tab {
  padding: 7px 14px; border-radius: 20px; font-size: 13px; font-weight: 600;
  background: none; border: 1px solid var(--border); color: var(--text2);
  cursor: pointer; transition: all 0.15s;
}
.filter-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-login" class="screen active">
  <div class="login-wrap">
    <div class="login-logo">Clinote</div>
    <div class="login-tagline">ë³‘ì› í™ë³´ë¥¼ ìœ„í•œ<br>AI ì½˜í…ì¸  íŒŒíŠ¸ë„ˆ</div>
    <div class="login-form">
      <div class="form-group">
        <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password">
      </div>
      <button class="btn btn-primary" onclick="doLogin()">
        <span id="login-btn-text">ë¡œê·¸ì¸</span>
      </button>
      <div class="error-msg" id="login-error"></div>
    </div>
    <button class="login-theme-btn" onclick="toggleTheme()">
      <span id="login-theme-icon">ğŸŒ™</span>
      <span id="login-theme-label">ë‹¤í¬ ëª¨ë“œ</span>
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• REPLY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-reply" class="screen">
  <div class="header">
    <h1>Clinote</h1>
    <span class="subtitle" id="clinic-name-header"></span>
    <button class="theme-btn" onclick="toggleTheme()" id="theme-btn-reply">ğŸŒ™</button>

  </div>
  <div class="scroll-area">
    <div class="form-group">
      <label>í”Œë«í¼</label>
      <div class="platform-tabs">
        <div class="platform-tab active" data-platform="naver" onclick="selectPlatform('naver')">ë„¤ì´ë²„</div>
        <div class="platform-tab" data-platform="kakao" onclick="selectPlatform('kakao')">ì¹´ì¹´ì˜¤</div>
        <div class="platform-tab" data-platform="google" onclick="selectPlatform('google')">êµ¬ê¸€</div>
      </div>
    </div>

    <div class="form-group">
      <label>ë³„ì  (ì„ íƒ)</label>
      <div class="stars" id="stars-container">
        <button class="star-btn" data-n="1" onclick="selectRating(1)">â˜…</button>
        <button class="star-btn" data-n="2" onclick="selectRating(2)">â˜…</button>
        <button class="star-btn" data-n="3" onclick="selectRating(3)">â˜…</button>
        <button class="star-btn" data-n="4" onclick="selectRating(4)">â˜…</button>
        <button class="star-btn" data-n="5" onclick="selectRating(5)">â˜…</button>
      </div>
    </div>

    <div class="form-group">
      <label>ë¦¬ë·° ë‚´ìš©</label>
      <textarea id="review-input" placeholder="ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ì—ì„œ ë¦¬ë·°ë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..." rows="5" oninput="onReviewInput()"></textarea>
      <div class="char-count" id="review-char">0ì</div>
    </div>

    <button class="btn btn-primary" id="generate-btn" onclick="generateReply()" disabled>
      <span id="generate-btn-content">ë‹µë³€ ìƒì„±</span>
    </button>

    <div style="margin-top: 20px;">
      <div class="section-title">ìƒì„±ëœ ë‹µë³€</div>
      <div class="reply-output empty" id="reply-output">ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
      <div class="char-count" id="reply-char"></div>
      <div class="copy-row" id="copy-row" style="display:none">
        <button class="btn btn-secondary btn-sm" onclick="copyReply()" style="flex:1">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>ë³µì‚¬
        </button>
        <button class="btn btn-secondary btn-sm" onclick="regenerateReply()" id="regen-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.5"/></svg>ì¬ìƒì„±
        </button>
        <button class="btn btn-secondary btn-sm" onclick="resetForm()">ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• TEMPLATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-template" class="screen">
  <div class="header">
    <h1>ë¬¸ìÂ·ê³µì§€</h1>
    <span class="subtitle" id="tmpl-clinic-header"></span>
    <button class="theme-btn" onclick="toggleTheme()">ğŸŒ™</button>
  </div>
  <div class="scroll-area">
    <p class="settings-header">í™˜ì ì•ˆë‚´ë¬¸, ê³µì§€, SNS ìº¡ì…˜ì„ AIë¡œ ë¹ ë¥´ê²Œ ìƒì„±í•˜ì„¸ìš”.</p>
    <div class="section-title">ìœ í˜• ì„ íƒ</div>
    <div class="tmpl-grid">
      <div class="tmpl-card" data-type="first_visit" onclick="selectTemplate('first_visit')">
        <div class="tmpl-icon">ğŸ¥</div>
        <div class="tmpl-name">ì´ˆì§„ ì•ˆë‚´ ë¬¸ì</div>
        <div class="tmpl-desc">ì²« ë°©ë¬¸ í™˜ì ì•ˆë‚´</div>
      </div>
      <div class="tmpl-card" data-type="after_care" onclick="selectTemplate('after_care')">
        <div class="tmpl-icon">ğŸ’Š</div>
        <div class="tmpl-name">ì¹˜ë£Œ í›„ ì£¼ì˜ì‚¬í•­</div>
        <div class="tmpl-desc">ì‹œìˆ  í›„ ì£¼ì˜ì‚¬í•­</div>
      </div>
      <div class="tmpl-card" data-type="recall" onclick="selectTemplate('recall')">
        <div class="tmpl-icon">ğŸ“…</div>
        <div class="tmpl-name">ì¬ë‚´ì› ìœ ë„ ë¬¸ì</div>
        <div class="tmpl-desc">ì •ê¸° ë‚´ì› ì•ˆë‚´</div>
      </div>
      <div class="tmpl-card" data-type="noshow" onclick="selectTemplate('noshow')">
        <div class="tmpl-icon">â°</div>
        <div class="tmpl-name">ë…¸ì‡¼ ë°©ì§€ ë¦¬ë§ˆì¸ë”</div>
        <div class="tmpl-desc">ì˜ˆì•½ ì•Œë¦¼ ë¬¸ì</div>
      </div>
      <div class="tmpl-card" data-type="holiday" onclick="selectTemplate('holiday')">
        <div class="tmpl-icon">ğŸ””</div>
        <div class="tmpl-name">íœ´ì§„ ê³µì§€</div>
        <div class="tmpl-desc">ì¹´ì¹´ì˜¤/ë¬¸ì/ì¸ìŠ¤íƒ€</div>
      </div>
      <div class="tmpl-card" data-type="sns" onclick="selectTemplate('sns')">
        <div class="tmpl-icon">ğŸ“±</div>
        <div class="tmpl-name">SNS ìº¡ì…˜</div>
        <div class="tmpl-desc">ì¸ìŠ¤íƒ€/ë¸”ë¡œê·¸</div>
      </div>
    </div>

    <div id="tmpl-params">
      <div class="divider"></div>
      <div id="tmpl-fields"></div>
      <button class="btn btn-primary" id="tmpl-generate-btn" onclick="generateTemplate()">
        <span id="tmpl-generate-text">ìƒì„±í•˜ê¸°</span>
      </button>
      <div style="margin-top: 20px;">
        <div class="section-title">ìƒì„±ëœ ë‚´ìš©</div>
        <div class="reply-output empty" id="tmpl-output">ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
        <div class="char-count" id="tmpl-char"></div>
        <div class="copy-row" id="tmpl-copy-row" style="display:none">
          <button class="btn btn-secondary btn-sm" onclick="copyTmpl()" style="flex:1">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>ë³µì‚¬
          </button>
          <button class="btn btn-secondary btn-sm" onclick="regenTemplate()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.5"/></svg>ì¬ìƒì„±
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• HISTORY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-history" class="screen">
  <div class="header">
    <h1>ì´ë ¥</h1>
    <button class="theme-btn" onclick="toggleTheme()">ğŸŒ™</button>
  </div>
  <div class="filter-tabs">
    <button class="filter-tab active" id="filter-all" onclick="setHistoryFilter('all')">ì „ì²´</button>
    <button class="filter-tab" id="filter-review" onclick="setHistoryFilter('review')">ë¦¬ë·° ë‹µë³€</button>
    <button class="filter-tab" id="filter-template" onclick="setHistoryFilter('template')">ë¬¸ìÂ·ê³µì§€</button>
  </div>
  <div class="scroll-area" id="history-list">
    <div class="empty-state"><div class="emoji">ğŸ“‹</div>ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-settings" class="screen">
  <div class="header">
    <h1>ë³‘ì› ì„¤ì •</h1>
    <button class="theme-btn" onclick="toggleTheme()">ğŸŒ™</button>
  </div>
  <div class="scroll-area">
    <p class="settings-header">ë³‘ì› ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ë§ì¶¤í˜• ë‹µë³€ê³¼ ë¬¸ìë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>

    <div class="section-title">ê¸°ë³¸ ì •ë³´</div>

    <div class="form-group">
      <label>ë³‘ì›ëª… *</label>
      <input type="text" id="s-name" placeholder="ì˜ˆ: ì„œìš¸ìŠ¤ë§ˆì¼ì¹˜ê³¼">
    </div>

    <div class="form-group">
      <label>ì§„ë£Œê³¼ëª©</label>
      <select id="s-specialty" onchange="onSpecialtyChange()">
        <option value="ì¹˜ê³¼">ì¹˜ê³¼</option>
        <option value="í•œì˜ì›">í•œì˜ì›</option>
        <option value="í”¼ë¶€ê³¼">í”¼ë¶€ê³¼</option>
        <option value="ì„±í˜•ì™¸ê³¼">ì„±í˜•ì™¸ê³¼</option>
        <option value="ì•ˆê³¼">ì•ˆê³¼</option>
        <option value="ì´ë¹„ì¸í›„ê³¼">ì´ë¹„ì¸í›„ê³¼</option>
        <option value="ì •í˜•ì™¸ê³¼">ì •í˜•ì™¸ê³¼</option>
        <option value="ë‚´ê³¼">ë‚´ê³¼</option>
        <option value="ë™ë¬¼ë³‘ì›">ë™ë¬¼ë³‘ì›</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
      </select>
    </div>

    <div class="form-group">
      <label>ì›ì¥ë‹˜ ì„±í•¨ (ì„ íƒ)</label>
      <input type="text" id="s-doctor" placeholder="ì˜ˆ: ê¹€ë¯¼ì¤€">
    </div>

    <div class="form-group">
      <label>ë‹µë³€ ë§íˆ¬</label>
      <select id="s-tone">
        <option value="formal">ì •ì¤‘í•˜ê³  ê³µì‹ì ì¸ ë§íˆ¬</option>
        <option value="friendly">ì¹œê·¼í•˜ê³  ë”°ëœ»í•œ ë§íˆ¬</option>
        <option value="professional">ì „ë¬¸ì ì´ê³  ì‹ ë¢°ê° ìˆëŠ” ë§íˆ¬</option>
      </select>
    </div>

    <div class="divider"></div>
    <div class="section-title">ì—°ë½ì²˜</div>

    <div class="form-group">
      <label>ì „í™”ë²ˆí˜¸</label>
      <input type="tel" id="s-phone" placeholder="ì˜ˆ: 02-1234-5678">
    </div>

    <div class="form-group">
      <label>ë„¤ì´ë²„ ì§€ë„ ë§í¬</label>
      <input type="url" id="s-naver-map" placeholder="https://naver.me/...">
    </div>

    <div class="divider"></div>
    <div class="section-title">SNS / ì±„ë„</div>

    <div class="form-group">
      <label>ì¸ìŠ¤íƒ€ê·¸ë¨</label>
      <input type="text" id="s-instagram" placeholder="ì˜ˆ: @seoul_smile_dental ë˜ëŠ” URL">
    </div>

    <div class="form-group">
      <label>ì¹´ì¹´ì˜¤ ì±„ë„</label>
      <input type="text" id="s-kakao-channel" placeholder="ì˜ˆ: @ì„œìš¸ìŠ¤ë§ˆì¼ì¹˜ê³¼ ë˜ëŠ” ì±„ë„ URL">
    </div>

    <div class="divider"></div>
    <div class="section-title">ë‹µë³€ ìŠ¤íƒ€ì¼</div>

    <!-- ê°•ì¡°ì‚¬í•­: ì¹© ì„ íƒ + ì»¤ìŠ¤í…€ -->
    <div class="form-group">
      <label>ê°•ì¡° ì‚¬í•­</label>
      <div class="chip-label">ìì£¼ ì“°ëŠ” í•­ëª© íƒ­í•´ì„œ ì¶”ê°€</div>
      <div class="chip-group" id="emphasis-chips"></div>
      <div class="add-tag-row">
        <input type="text" id="s-emphasis-input" placeholder="ì§ì ‘ ì…ë ¥ í›„ ì¶”ê°€" onkeydown="if(event.key==='Enter'){addEmphasis();event.preventDefault();}">
        <button class="btn btn-secondary btn-sm" onclick="addEmphasis()">ì¶”ê°€</button>
      </div>
      <div class="tags-wrap" id="emphasis-tags"></div>
    </div>

    <!-- ê¸ˆì§€ì–´ -->
    <div class="form-group">
      <label>ê¸ˆì§€ì–´</label>
      <div class="chip-label">ìì£¼ ì“°ëŠ” ê¸ˆì§€ì–´ ì˜ˆì‹œ</div>
      <div class="chip-group">
        <div class="chip" onclick="addForbiddenChip('ìµœê³ ')">ìµœê³ </div>
        <div class="chip" onclick="addForbiddenChip('1ë“±')">1ë“±</div>
        <div class="chip" onclick="addForbiddenChip('ì „êµ­ ìµœì´ˆ')">ì „êµ­ ìµœì´ˆ</div>
        <div class="chip" onclick="addForbiddenChip('ì™„ì¹˜')">ì™„ì¹˜</div>
        <div class="chip" onclick="addForbiddenChip('ë³´ì¥')">ë³´ì¥</div>
        <div class="chip" onclick="addForbiddenChip('100%')">100%</div>
        <div class="chip" onclick="addForbiddenChip('ë¬´ì¡°ê±´')">ë¬´ì¡°ê±´</div>
        <div class="chip" onclick="addForbiddenChip('íŠ¹íš¨')">íŠ¹íš¨</div>
      </div>
      <div class="add-tag-row">
        <input type="text" id="s-forbidden-input" placeholder="ê¸ˆì§€ì–´ ì…ë ¥ í›„ ì¶”ê°€" onkeydown="if(event.key==='Enter'){addForbiddenWord();event.preventDefault();}">
        <button class="btn btn-secondary btn-sm" onclick="addForbiddenWord()">ì¶”ê°€</button>
      </div>
      <div class="forbidden-tags" id="forbidden-tags"></div>
    </div>

    <button class="btn btn-primary" onclick="saveSettings()">
      <span id="settings-btn-text">ì„¤ì • ì €ì¥</span>
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="bottom-nav" id="bottom-nav">
  <button class="nav-btn active" id="nav-reply" onclick="showScreen('reply')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    ë¦¬ë·° ë‹µë³€
  </button>
  <button class="nav-btn" id="nav-template" onclick="showScreen('template')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
    ë¬¸ìÂ·ê³µì§€
  </button>
  <button class="nav-btn" id="nav-history" onclick="showScreen('history')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    ì´ë ¥
  </button>
  <button class="nav-btn" id="nav-settings" onclick="showScreen('settings')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    ì„¤ì •
  </button>
</nav>

<div id="toast"></div>

<script>
// â•â• Data â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SPECIALTY_EMPHASIS = {
  'ì¹˜ê³¼': [
    'ë¬´í†µ ë§ˆì·¨', 'ì„í”Œë€íŠ¸ ì „ë¬¸', 'ì–´ë¦°ì´ ì¹˜ê³¼', 'ë‹¹ì¼ ì‘ê¸‰ì§„ë£Œ',
    'íˆ¬ëª…êµì •(ì¸ë¹„ì ˆë¼ì¸)', 'ì„¸ë¼ë¯¹ êµì •', 'ë¼ë¯¸ë„¤ì´íŠ¸', 'ì‡ëª¸ ì¹˜ë£Œ',
    'ë‹¹ì¼ ì„í”Œë€íŠ¸', 'ë””ì§€í„¸ êµ¬ê°•ìŠ¤ìºë„ˆ', 'ìˆ˜ë©´ ì§„ë£Œ', 'ì¹˜ì•„ë¯¸ë°±',
    'í‹€ë‹ˆÂ·ë³´ì²  ì „ë¬¸', 'ì‚¬ë‘ë‹ˆ ë‹¹ì¼ ë°œì¹˜', 'ì „ë¬¸ì˜ ìƒì£¼', 'í„±ê´€ì ˆ ì¹˜ë£Œ',
    'ì¹˜ì•„ ì„±í˜•', 'ë ˆì§„ ìˆ˜ë³µ', 'ì˜ë£Œë³´í—˜ ì ìš©',
  ],
  'í•œì˜ì›': [
    'ì¶”ë‚˜ìš”ë²•', 'ì¹¨ ì¹˜ë£Œ', 'í•œì•½ ì²˜ë°©', 'ë‹¤ì´ì–´íŠ¸ í•œì˜ì›',
    'ë¶ˆì„Â·ë‚œì„ ì¹˜ë£Œ', 'ì²´ì§ˆ ë¶„ì„', 'ë””ìŠ¤í¬ ì¹˜ë£Œ', 'ê°±ë…„ê¸° ì¹˜ë£Œ',
    'ì†Œì•„ í•œì˜í•™', 'ìŠ¤í¬ì¸  í•œì˜', 'í™”ë³‘ ì¹˜ë£Œ', 'í”¼ë¶€ í•œì˜',
    'ì•¼ê°„ ì§„ë£Œ', 'ë‹¹ì¼ í•œì•½ ì¡°ì œ', 'ë¹„ê¸‰ì—¬ í•­ëª© íˆ¬ëª… ê³µê°œ',
  ],
  'í”¼ë¶€ê³¼': [
    'ë ˆì´ì € ì¹˜ë£Œ', 'ë³´í†¡ìŠ¤', 'í•„ëŸ¬', 'í”¼ë¶€ ë¯¸ë°±',
    'ì—¬ë“œë¦„ ì¹˜ë£Œ', 'ì•„í† í”¼ ì „ë¬¸', 'ë¦¬í”„íŒ…', 'ìƒ‰ì†Œ ì¹˜ë£Œ',
    'ì‹¤ ë¦¬í”„íŒ…', 'ëª¨ê³µ ì¹˜ë£Œ', 'íƒˆëª¨ ì¹˜ë£Œ', 'ì œëª¨ ë ˆì´ì €',
    'í‰í„° ì¹˜ë£Œ', 'í”¼ë¶€ ê±´ê°•ê²€ì§„', 'í•´ì™¸ ë¸Œëœë“œ ì œí’ˆ ì‚¬ìš©',
  ],
  'ì„±í˜•ì™¸ê³¼': [
    'ìì—°ìŠ¤ëŸ¬ìš´ ê²°ê³¼', 'ìŒêº¼í’€ ì „ë¬¸', 'ì½” ì„±í˜•', 'ì§€ë°©í¡ì…',
    'ëˆˆ ì„±í˜•', 'ì•ˆë©´ìœ¤ê³½', 'ìˆ˜ì •Â·ì¬ìˆ˜ìˆ  ì „ë¬¸', 'ë¬´í‰í„° ê¸°ë²•',
    'ê°€ìŠ´ ì„±í˜•', 'ë°”ë”” ì»¨íˆ¬ì–´ë§', 'ì™¸êµ­ì¸ í™˜ì ê²½í—˜ í’ë¶€',
  ],
  'ì•ˆê³¼': [
    'ë¼ì‹Â·ë¼ì„¹ ì „ë¬¸', 'ìŠ¤ë§ˆì¼ ë¼ì‹', 'ë°±ë‚´ì¥ ìˆ˜ìˆ ',
    'ë§ë§‰ ì „ë¬¸', 'ë…¹ë‚´ì¥ ì¹˜ë£Œ', 'ë“œë¦¼ë Œì¦ˆ', 'ë…¸ì•ˆ êµì •',
    'ì†Œì•„ ì•ˆê³¼', 'ì˜ë£Œìš© ì½˜íƒíŠ¸ë Œì¦ˆ', '3D ì•ˆì € ì´¬ì˜',
  ],
  'ì´ë¹„ì¸í›„ê³¼': [
    'ì½” ìˆ˜ìˆ Â·ê¸°ëŠ¥ êµì •', 'í¸ë„ ìˆ˜ìˆ ', 'ì¤‘ì´ì—¼ ì¹˜ë£Œ',
    'ìˆ˜ë©´ë¬´í˜¸í¡', 'ì•Œë ˆë¥´ê¸° ì¹˜ë£Œ', 'ë³´ì²­ê¸° ìƒë‹´', 'í›„ë‘Â·ìŒì„± ì¹˜ë£Œ',
    'êµ¬ë‚´ì—¼Â·í¸ë„ì—¼', 'ë¹„ì—¼ ì¹˜ë£Œ', 'ì²­ê° ê²€ì‚¬',
  ],
  'ì •í˜•ì™¸ê³¼': [
    'ê´€ì ˆ ë‚´ì‹œê²½', 'ì²™ì¶” ì „ë¬¸', 'ìŠ¤í¬ì¸  ì†ìƒ', 'ì¸ê³µê´€ì ˆ',
    'ë„ìˆ˜ì¹˜ë£Œ', 'ì²´ì™¸ì¶©ê²©íŒŒ', 'ì¬í™œì¹˜ë£Œ', 'ì£¼ì‚¬ ì¹˜ë£Œ',
    'ê³¨ì ˆÂ·ì™¸ìƒ', 'MRI ì¦‰ì‹œ íŒë…',
  ],
  'ë‚´ê³¼': [
    'ê±´ê°•ê²€ì§„', 'ë‹¹ë‡¨ ì „ë¬¸', 'ê³ í˜ˆì•• ê´€ë¦¬', 'ì†Œí™”ê¸° ì „ë¬¸',
    'ê°‘ìƒì„  ì¹˜ë£Œ', 'ê°„ ì§ˆí™˜', 'ê¸ˆì—° í´ë¦¬ë‹‰', 'ì˜ì–‘ ìˆ˜ì•¡',
    'ìˆ˜ë©´ ë‚´ì‹œê²½', 'ëŒ€ì¥ ë‚´ì‹œê²½', 'ìœ„ ë‚´ì‹œê²½',
  ],
  'ë™ë¬¼ë³‘ì›': [
    '24ì‹œê°„ ì‘ê¸‰', 'ë‚´ê³¼ ì „ë¬¸', 'ì™¸ê³¼ ìˆ˜ìˆ ', 'ì¹˜ê³¼ ìŠ¤ì¼€ì¼ë§',
    'ì˜ˆë°©ì ‘ì¢…', 'í”¼ë¶€ ì „ë¬¸', 'ì•ˆê³¼ ì „ë¬¸', 'ì˜ì–‘ ìƒë‹´',
    'ê³ ì–‘ì´ ì „ë¬¸', 'ê°•ì•„ì§€ ì „ë¬¸', 'í¬ê·€ ë™ë¬¼ ì§„ë£Œ', 'ì…ì›ì‹¤ ìš´ì˜',
    'ëª¨ë°”ì¼ X-ray', 'ì‹¬ì¥ ì´ˆìŒíŒŒ',
  ],
  'ê¸°íƒ€': [
    'ì „ë¬¸ì˜ ìƒì£¼', 'ë‹¹ì¼ ì§„ë£Œ', 'ì˜ˆì•½ì œ ìš´ì˜', 'ì£¼ì°¨ ê°€ëŠ¥',
    'ì•¼ê°„ ì§„ë£Œ', 'í† Â·ì¼ ì§„ë£Œ', 'ì¹œì ˆí•œ ìƒë‹´', 'ì²­ê²°í•œ í™˜ê²½',
    'ë¹„ê¸‰ì—¬ í•­ëª© íˆ¬ëª… ê³µê°œ', 'ì™¸êµ­ì–´ ê°€ëŠ¥',
  ],
};

const TEMPLATES = {
  first_visit: {
    label: 'ì´ˆì§„ ì•ˆë‚´ ë¬¸ì',
    fields: [
      {
        id: 'appt_date', label: 'ì˜ˆì•½ ë‚ ì§œÂ·ì‹œê°„', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ ì˜ˆì‹œ íƒ­',
        chips: ['ë‚´ì¼ ì˜¤ì „ 10ì‹œ', 'ë‚´ì¼ ì˜¤í›„ 2ì‹œ', 'ì´ë²ˆ ì£¼ í† ìš”ì¼ ì˜¤ì „', 'ë‹¤ìŒ ì£¼ ì›”ìš”ì¼'],
      },
      {
        id: 'note', label: 'ì¶”ê°€ ì•ˆë‚´ (ì„ íƒ)', required: false, textarea: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ ì˜ˆì‹œ íƒ­',
        chips: ['ì£¼ì°¨ ê°€ëŠ¥', 'ëŒ€ì¤‘êµí†µ ì´ìš© ê¶Œì¥', 'ì ‘ìˆ˜ 5ë¶„ ì „ ë„ì°© ê¶Œì¥', 'ì‹ ë¶„ì¦ ì§€ì°¸ ìš”ì²­', 'ë³´í˜¸ì ë™ë°˜ ê¶Œì¥'],
      },
    ]
  },
  after_care: {
    label: 'ì¹˜ë£Œ í›„ ì£¼ì˜ì‚¬í•­',
    fields: [
      {
        id: 'treatment', label: 'ì¹˜ë£Œ í•­ëª©', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: {
          'ì¹˜ê³¼': ['ì„í”Œë€íŠ¸ ìˆ˜ìˆ ', 'ìŠ¤ì¼€ì¼ë§', 'ì‹ ê²½ì¹˜ë£Œ', 'ë°œì¹˜', 'ë³´ì²  ì¥ì°©', 'êµì • ì¥ì¹˜ ë¶€ì°©', 'ì¹˜ì•„ë¯¸ë°±', 'ì‡ëª¸ ì¹˜ë£Œ', 'ë¼ë¯¸ë„¤ì´íŠ¸', 'ë ˆì§„ ìˆ˜ë³µ'],
          'í”¼ë¶€ê³¼': ['ë ˆì´ì € ì‹œìˆ ', 'ë³´í†¡ìŠ¤', 'í•„ëŸ¬', 'ë°•í”¼', 'ë¦¬í”„íŒ…', 'ì œëª¨'],
          'ì •í˜•ì™¸ê³¼': ['ê´€ì ˆ ë‚´ì‹œê²½', 'ì£¼ì‚¬ ì¹˜ë£Œ', 'ë„ìˆ˜ì¹˜ë£Œ', 'ì²´ì™¸ì¶©ê²©íŒŒ'],
          'í•œì˜ì›': ['ì¹¨ ì¹˜ë£Œ', 'ëœ¸ ì¹˜ë£Œ', 'ì¶”ë‚˜ìš”ë²•', 'í•œì•½ ë³µìš© ì‹œì‘'],
          default: ['ìˆ˜ìˆ ', 'ì‹œìˆ ', 'ì£¼ì‚¬ ì¹˜ë£Œ', 'ë ˆì´ì € ì¹˜ë£Œ', 'ì²˜ì¹˜'],
        },
      },
      {
        id: 'note', label: 'ì¶”ê°€ ì•ˆë‚´ (ì„ íƒ)', required: false, textarea: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['í•­ìƒì œ ì²˜ë°©ë¨', 'ì§„í†µì œ ì²˜ë°©ë¨', '3ì¼ í›„ ì¬ë‚´ì› í•„ìš”', '1ì£¼ì¼ í›„ ì‹¤ë°¥ ì œê±°', 'ëƒ‰ì°œì§ˆ ê¶Œì¥', 'ìŒì£¼Â·í¡ì—° ê¸ˆì§€ 1ì£¼', 'ê²©í•œ ìš´ë™ ê¸ˆì§€'],
      },
    ]
  },
  recall: {
    label: 'ì¬ë‚´ì› ìœ ë„ ë¬¸ì',
    fields: [
      {
        id: 'interval', label: 'ê¶Œì¥ ë‚´ì› ì£¼ê¸°', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['3ê°œì›”', '6ê°œì›”', '1ë…„', '2ë…„', 'ë§¤ì›”'],
      },
      {
        id: 'service', label: 'ê¶Œì¥ ì„œë¹„ìŠ¤', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: {
          'ì¹˜ê³¼': ['ìŠ¤ì¼€ì¼ë§', 'ì •ê¸° ê²€ì§„', 'ë¶ˆì†Œ ë„í¬', 'ì‹¤ë€íŠ¸', 'êµì • ì ê²€', 'ì„í”Œë€íŠ¸ ì ê²€', 'êµ¬ê°• ìœ„ìƒ ê´€ë¦¬'],
          'ì•ˆê³¼': ['ì‹œë ¥ ê²€ì‚¬', 'ì•ˆì•• ê²€ì‚¬', 'ë“œë¦¼ë Œì¦ˆ ì ê²€'],
          'ë‚´ê³¼': ['í˜ˆì•¡ ê²€ì‚¬', 'í˜ˆì•• ì¸¡ì •', 'í˜ˆë‹¹ ì¸¡ì •', 'ê±´ê°•ê²€ì§„'],
          default: ['ì •ê¸° ê²€ì§„', 'ì¶”ì  ê´€ì°°', 'ì¹˜ë£Œ í›„ ì ê²€'],
        },
      },
    ]
  },
  noshow: {
    label: 'ë…¸ì‡¼ ë°©ì§€ ë¦¬ë§ˆì¸ë”',
    fields: [
      {
        id: 'appt_date', label: 'ì˜ˆì•½ ë‚ ì§œÂ·ì‹œê°„', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['ë‚´ì¼ ì˜¤ì „ 10ì‹œ', 'ë‚´ì¼ ì˜¤í›„ 2ì‹œ', 'ë‚´ì¼ ì˜¤í›„ 4ì‹œ', 'ëª¨ë ˆ ì˜¤ì „ 11ì‹œ'],
      },
      {
        id: 'treatment', label: 'ì˜ˆì•½ ì§„ë£Œ (ì„ íƒ)', required: false,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: {
          'ì¹˜ê³¼': ['ì„í”Œë€íŠ¸ ìƒë‹´', 'ìŠ¤ì¼€ì¼ë§', 'ì‹ ê²½ì¹˜ë£Œ', 'ë³´ì²  ì ê²€', 'êµì • ì ê²€', 'ë°œì¹˜'],
          default: ['ìƒë‹´', 'ì •ê¸° ê²€ì§„', 'ì²˜ì¹˜', 'ìˆ˜ìˆ  ì „ ê²€ì‚¬'],
        },
      },
    ]
  },
  holiday: {
    label: 'íœ´ì§„ ê³µì§€',
    fields: [
      {
        id: 'date_range', label: 'íœ´ì§„ ê¸°ê°„', required: true,
        placeholder: 'ì˜ˆ: 3ì›” 1ì¼(í† )~3ì¼(ì›”)',
        chips: [],
      },
      {
        id: 'reason', label: 'ì‚¬ìœ  (ì„ íƒ)', required: false,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['ì„¤ ì—°íœ´', 'ì¶”ì„ ì—°íœ´', 'í•™íšŒ ì°¸ì„', 'ë³‘ì› ë¦¬ëª¨ë¸ë§', 'ì›ì¥ë‹˜ ë¶€ì¬', 'ê³µíœ´ì¼'],
      },
      {
        id: 'resume_date', label: 'ì •ìƒ ì§„ë£Œ ì¬ê°œì¼', required: true,
        placeholder: 'ì˜ˆ: 3ì›” 4ì¼(í™”)ë¶€í„° ì •ìƒ ì§„ë£Œ',
        chips: [],
      },
      {
        id: 'channel', label: 'ì±„ë„ (ì„ íƒ)', required: false,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['ì¹´ì¹´ì˜¤', 'ë¬¸ì', 'ì¸ìŠ¤íƒ€ê·¸ë¨', 'ë„¤ì´ë²„ ë¸”ë¡œê·¸'],
      },
    ]
  },
  sns: {
    label: 'SNS ìº¡ì…˜',
    fields: [
      {
        id: 'topic', label: 'ì£¼ì œ', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: {
          'ì¹˜ê³¼': ['ì„í”Œë€íŠ¸ ì´ë²¤íŠ¸', 'ìŠ¤ì¼€ì¼ë§ ì•ˆë‚´', 'íˆ¬ëª…êµì • ìƒë‹´', 'ì¹˜ì•„ë¯¸ë°± ì´ë²¤íŠ¸', 'ì–´ë¦°ì´ë‚  ì´ë²¤íŠ¸', 'ê³„ì ˆ ì¸ì‚¬'],
          'í”¼ë¶€ê³¼': ['ë³´í†¡ìŠ¤ ì´ë²¤íŠ¸', 'ì—¬ë“œë¦„ ì¹˜ë£Œ', 'ë ˆì´ì € ë¦¬í”„íŒ…', 'ê°€ì„ í”¼ë¶€ê´€ë¦¬'],
          default: ['ì‹ ê·œ ì¥ë¹„ ë„ì…', 'ì´ë²¤íŠ¸ ì•ˆë‚´', 'ê³„ì ˆ ì¸ì‚¬', 'ê±´ê°• ì •ë³´', 'ì›ì¥ë‹˜ ì†Œê°œ'],
        },
      },
      {
        id: 'platform', label: 'SNS ì±„ë„', required: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['ì¸ìŠ¤íƒ€ê·¸ë¨', 'ë„¤ì´ë²„ ë¸”ë¡œê·¸', 'ì¹´ì¹´ì˜¤ìŠ¤í† ë¦¬', 'ìœ íŠœë¸Œ ì‡¼ì¸ '],
      },
      {
        id: 'note', label: 'ì¶”ê°€ ìš”ì²­ (ì„ íƒ)', required: false, textarea: true,
        placeholder: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ íƒ­',
        chips: ['í•´ì‹œíƒœê·¸ í¬í•¨', 'ì´ëª¨ì§€ ì‚¬ìš©', 'ì¹œê·¼í•œ í†¤', 'ì „ë¬¸ì ì¸ í†¤', 'ì§§ê³  ì„íŒ©íŠ¸ ìˆê²Œ', 'ìŠ¤í† ë¦¬í…”ë§ í˜•ì‹'],
      },
    ]
  },
};

// â•â• State â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let token = localStorage.getItem('clinote_token') || '';
let currentScreen = 'login';
let selectedPlatform = 'naver';
let selectedRating = null;
let currentReplyText = '';
let lastReviewText = '';
let lastRating = null;
let selectedTmplType = null;
let currentTmplText = '';
let emphasisList = [];
let forbiddenWords = [];
let currentSpecialty = 'ì¹˜ê³¼';

// â•â• Theme â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTheme() {
  const saved = localStorage.getItem('clinote_theme') || 'light';
  setTheme(saved);
}

function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('clinote_theme', theme);
  const isDark = theme === 'dark';
  const icon = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
  const label = isDark ? 'ë¼ì´íŠ¸ ëª¨ë“œ' : 'ë‹¤í¬ ëª¨ë“œ';
  document.querySelectorAll('.theme-btn').forEach(b => b.textContent = icon);
  const li = document.getElementById('login-theme-icon');
  const ll = document.getElementById('login-theme-label');
  if (li) li.textContent = icon;
  if (ll) ll.textContent = label;
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme');
  setTheme(current === 'dark' ? 'light' : 'dark');
}

// â•â• Utilities â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(method, path, body = null) {
  const opts = { method, headers: { 'Authorization': `Bearer ${token}` } };
  if (body !== null) {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(body);
  }
  const r = await fetch(path, opts);
  if (r.status === 401) {
    localStorage.removeItem('clinote_token');
    token = '';
    showScreen('login');
    throw new Error('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
  if (!r.ok) {
    const text = await r.text();
    let msg = text;
    try { msg = JSON.parse(text).detail || text; } catch {}
    throw new Error(msg);
  }
  return r.json();
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const nb = document.getElementById(`nav-${name}`);
  if (nb) nb.classList.add('active');
  currentScreen = name;
  if (name === 'history') loadHistory();
  if (name === 'settings') loadSettings();
  if (name === 'template') loadTmplClinicHeader();
}

// â•â• Auth â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
  const pw = document.getElementById('login-pw').value;
  const errEl = document.getElementById('login-error');
  const btnText = document.getElementById('login-btn-text');
  errEl.textContent = '';
  btnText.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
  try {
    const r = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw }),
    });
    if (!r.ok) {
      const d = await r.json().catch(() => ({}));
      throw new Error(d.detail || 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
    }
    const { token: t } = await r.json();
    token = t;
    localStorage.setItem('clinote_token', t);
    afterLogin();
  } catch (e) {
    errEl.textContent = e.message;
  } finally {
    btnText.textContent = 'ë¡œê·¸ì¸';
  }
}

async function afterLogin() {
  document.getElementById('bottom-nav').classList.add('visible');
  showScreen('reply');
  try {
    const clinic = await api('GET', '/api/clinic');
    updateClinicHeader(clinic);
    if (!clinic.name) showScreen('settings');
  } catch {}
}

function updateClinicHeader(clinic) {
  const name = clinic.name ? `${clinic.name} ${clinic.specialty}` : '';
  document.getElementById('clinic-name-header').textContent = name;
}

async function loadTmplClinicHeader() {
  try {
    const clinic = await api('GET', '/api/clinic');
    const el = document.getElementById('tmpl-clinic-header');
    if (el) el.textContent = clinic.name ? `${clinic.name}` : '';
  } catch {}
}

// â•â• Reply screen â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectPlatform(p) {
  selectedPlatform = p;
  document.querySelectorAll('.platform-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.platform === p);
  });
}

function selectRating(n) {
  if (selectedRating === n) {
    selectedRating = null;
    document.querySelectorAll('.star-btn').forEach(b => b.classList.remove('active'));
    return;
  }
  selectedRating = n;
  document.querySelectorAll('.star-btn').forEach(b => {
    b.classList.toggle('active', parseInt(b.dataset.n) <= n);
  });
}

function onReviewInput() {
  const val = document.getElementById('review-input').value;
  document.getElementById('generate-btn').disabled = val.trim().length < 5;
  const cc = document.getElementById('review-char');
  cc.textContent = `${val.length}ì`;
  cc.className = 'char-count' + (val.length > 500 ? ' warn' : '');
}

async function generateReply() {
  const reviewText = document.getElementById('review-input').value.trim();
  if (!reviewText) return;
  lastReviewText = reviewText;
  lastRating = selectedRating;
  await _doGenerateReply(reviewText, selectedRating);
}

async function regenerateReply() {
  if (!lastReviewText) return;
  await _doGenerateReply(lastReviewText, lastRating);
}

async function _doGenerateReply(reviewText, rating) {
  const btn = document.getElementById('generate-btn');
  const btnContent = document.getElementById('generate-btn-content');
  const regenBtn = document.getElementById('regen-btn');
  const outputEl = document.getElementById('reply-output');
  const copyRow = document.getElementById('copy-row');
  const replyChar = document.getElementById('reply-char');

  btn.disabled = true;
  if (regenBtn) regenBtn.disabled = true;
  btnContent.innerHTML = '<div class="spinner"></div> ìƒì„± ì¤‘...';
  outputEl.textContent = '';
  outputEl.classList.remove('empty');
  copyRow.style.display = 'none';
  currentReplyText = '';

  try {
    const r = await fetch('/api/review/generate', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ platform: selectedPlatform, rating, original_text: reviewText }),
    });
    if (!r.ok) throw new Error('ìƒì„± ì‹¤íŒ¨');
    await _readStream(r, chunk => {
      currentReplyText += chunk;
      outputEl.textContent = currentReplyText;
      replyChar.textContent = `${currentReplyText.length}ì`;
    }, () => {
      copyRow.style.display = 'flex';
    }, err => {
      outputEl.textContent = 'ì˜¤ë¥˜: ' + err;
      outputEl.classList.add('empty');
    });
  } catch (e) {
    outputEl.textContent = 'ì˜¤ë¥˜: ' + e.message;
    outputEl.classList.add('empty');
  } finally {
    btn.disabled = false;
    if (regenBtn) regenBtn.disabled = false;
    btnContent.textContent = 'ë‹µë³€ ìƒì„±';
    onReviewInput();
  }
}

function copyReply() {
  if (!currentReplyText) return;
  navigator.clipboard.writeText(currentReplyText).then(() => toast('ë‹µë³€ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“'));
}

function resetForm() {
  document.getElementById('review-input').value = '';
  document.getElementById('reply-output').textContent = 'ë‹µë³€ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤';
  document.getElementById('reply-output').classList.add('empty');
  document.getElementById('copy-row').style.display = 'none';
  document.getElementById('reply-char').textContent = '';
  document.getElementById('review-char').textContent = '0ì';
  selectedRating = null;
  lastReviewText = '';
  lastRating = null;
  document.querySelectorAll('.star-btn').forEach(b => b.classList.remove('active'));
  currentReplyText = '';
  onReviewInput();
}

// â•â• SSE stream helper â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function _readStream(response, onChunk, onDone, onError) {
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop();
    for (const line of lines) {
      if (!line.startsWith('data: ')) continue;
      try {
        const d = JSON.parse(line.slice(6));
        if (d.chunk) onChunk(d.chunk);
        if (d.done) onDone();
        if (d.error) onError(d.error);
      } catch {}
    }
  }
}

// â•â• Template screen â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectTemplate(type) {
  selectedTmplType = type;
  document.querySelectorAll('.tmpl-card').forEach(c => c.classList.toggle('selected', c.dataset.type === type));

  const tmpl = TEMPLATES[type];
  if (!tmpl) return;

  const fieldsEl = document.getElementById('tmpl-fields');
  fieldsEl.innerHTML = tmpl.fields.map(f => {
    // Resolve chips (specialty-aware)
    let chips = f.chips;
    if (chips && typeof chips === 'object' && !Array.isArray(chips)) {
      chips = chips[currentSpecialty] || chips['default'] || [];
    }
    chips = chips || [];

    const chipsHtml = chips.length ? `
      <div class="chip-group">${chips.map(c => `<div class="chip" onclick="tmplChipClick(this,'tf-${f.id}')">${escapeHtml(c)}</div>`).join('')}</div>
    ` : '';

    const inputHtml = f.textarea
      ? `<textarea id="tf-${f.id}" placeholder="${f.placeholder}" rows="3"></textarea>`
      : `<input type="text" id="tf-${f.id}" placeholder="${f.placeholder}">`;

    return `<div class="form-group">
      <label>${f.label}${f.required ? ' *' : ''}</label>
      ${chipsHtml}
      ${inputHtml}
    </div>`;
  }).join('');

  // Reset output
  document.getElementById('tmpl-output').textContent = 'ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤';
  document.getElementById('tmpl-output').classList.add('empty');
  document.getElementById('tmpl-copy-row').style.display = 'none';
  document.getElementById('tmpl-char').textContent = '';
  currentTmplText = '';

  const paramsEl = document.getElementById('tmpl-params');
  paramsEl.classList.add('visible');
  paramsEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function tmplChipClick(chipEl, inputId) {
  const inputEl = document.getElementById(inputId);
  if (!inputEl) return;
  const val = chipEl.textContent.trim();
  const cur = inputEl.value.trim();
  // Toggle: if already in input, remove; else append
  if (cur.includes(val)) {
    inputEl.value = cur.replace(val, '').replace(/,\s*,/g, ',').replace(/^,\s*|,\s*$/g, '').trim();
    chipEl.classList.remove('selected');
  } else {
    inputEl.value = cur ? `${cur}, ${val}` : val;
    chipEl.classList.add('selected');
  }
}

async function generateTemplate() {
  if (!selectedTmplType) return;
  const tmpl = TEMPLATES[selectedTmplType];
  const params = {};
  let valid = true;
  for (const f of tmpl.fields) {
    const el = document.getElementById(`tf-${f.id}`);
    const val = el ? el.value.trim() : '';
    if (f.required && !val) {
      el && el.focus();
      toast(`${f.label}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”`);
      valid = false;
      break;
    }
    params[f.id] = val;
  }
  if (!valid) return;
  await _doGenerateTemplate(selectedTmplType, params);
}

async function regenTemplate() {
  if (!selectedTmplType) return;
  const tmpl = TEMPLATES[selectedTmplType];
  const params = {};
  for (const f of tmpl.fields) {
    const el = document.getElementById(`tf-${f.id}`);
    params[f.id] = el ? el.value.trim() : '';
  }
  await _doGenerateTemplate(selectedTmplType, params);
}

async function _doGenerateTemplate(type, params) {
  const btn = document.getElementById('tmpl-generate-btn');
  const btnText = document.getElementById('tmpl-generate-text');
  const outputEl = document.getElementById('tmpl-output');
  const copyRow = document.getElementById('tmpl-copy-row');
  const charEl = document.getElementById('tmpl-char');

  btn.disabled = true;
  btnText.innerHTML = '<div class="spinner"></div> ìƒì„± ì¤‘...';
  outputEl.textContent = '';
  outputEl.classList.remove('empty');
  copyRow.style.display = 'none';
  currentTmplText = '';

  try {
    const r = await fetch('/api/template/generate', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ template_type: type, params }),
    });
    if (!r.ok) throw new Error('ìƒì„± ì‹¤íŒ¨');
    await _readStream(r, chunk => {
      currentTmplText += chunk;
      outputEl.textContent = currentTmplText;
      charEl.textContent = `${currentTmplText.length}ì`;
    }, () => {
      copyRow.style.display = 'flex';
    }, err => {
      outputEl.textContent = 'ì˜¤ë¥˜: ' + err;
      outputEl.classList.add('empty');
    });
  } catch (e) {
    outputEl.textContent = 'ì˜¤ë¥˜: ' + e.message;
    outputEl.classList.add('empty');
  } finally {
    btn.disabled = false;
    btnText.textContent = 'ìƒì„±í•˜ê¸°';
  }
}

function copyTmpl() {
  if (!currentTmplText) return;
  navigator.clipboard.writeText(currentTmplText).then(() => toast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“'));
}

// â•â• History â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _historyFilter = 'all';
let _historyCache = [];

function setHistoryFilter(type) {
  _historyFilter = type;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('filter-' + type).classList.add('active');
  renderHistoryList();
}

function renderHistoryList() {
  const listEl = document.getElementById('history-list');
  const filtered = _historyFilter === 'all'
    ? _historyCache
    : _historyCache.filter(item => item._type === _historyFilter);

  if (!filtered.length) {
    listEl.innerHTML = '<div class="empty-state"><div class="emoji">ğŸ“‹</div>í•´ë‹¹í•˜ëŠ” ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }

  listEl.innerHTML = filtered.map(item => {
    const date = item.created_at ? item.created_at.substring(0, 16) : '';
    if (item._type === 'review') {
      const stars = item.rating ? 'â˜…'.repeat(item.rating) + 'â˜†'.repeat(5 - item.rating) : '';
      const platformLabel = { naver: 'ë„¤ì´ë²„', kakao: 'ì¹´ì¹´ì˜¤', google: 'êµ¬ê¸€' }[item.platform] || item.platform;
      return `<div class="history-card">
        <div class="meta">
          <span class="platform-badge">ë¦¬ë·° ë‹µë³€</span>
          <span class="platform-badge">${platformLabel}</span>
          ${stars ? `<span class="rating-stars">${stars}</span>` : ''}
          <span class="history-date">${date}</span>
        </div>
        <div class="history-review">${escapeHtml(item.original_text.substring(0, 100))}${item.original_text.length > 100 ? '...' : ''}</div>
        <div class="history-reply">${escapeHtml(item.reply_text)}</div>
        <div class="history-actions">
          <button class="btn btn-secondary btn-sm" onclick="copyText(${JSON.stringify(item.reply_text)})">ë³µì‚¬</button>
          <button class="btn btn-danger btn-sm" onclick="deleteReview(${item.id}, this)">ì‚­ì œ</button>
        </div>
      </div>`;
    } else {
      const paramsStr = Object.values(item.params || {}).filter(Boolean).join(' Â· ');
      return `<div class="history-card">
        <div class="meta">
          <span class="platform-badge">ë¬¸ìÂ·ê³µì§€</span>
          <span class="platform-badge">${escapeHtml(item.label || item.template_type)}</span>
          <span class="history-date">${date}</span>
        </div>
        ${paramsStr ? `<div class="history-review">${escapeHtml(paramsStr.substring(0, 80))}</div>` : ''}
        <div class="history-reply">${escapeHtml(item.output_text)}</div>
        <div class="history-actions">
          <button class="btn btn-secondary btn-sm" onclick="copyText(${JSON.stringify(item.output_text)})">ë³µì‚¬</button>
          <button class="btn btn-danger btn-sm" onclick="deleteTemplate(${item.id}, this)">ì‚­ì œ</button>
        </div>
      </div>`;
    }
  }).join('');
}

async function loadHistory() {
  const listEl = document.getElementById('history-list');
  listEl.innerHTML = '<div class="empty-state"><div class="emoji">â³</div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  try {
    const [reviewRes, tmplRes] = await Promise.all([
      api('GET', '/api/reviews?limit=50'),
      api('GET', '/api/templates?limit=50'),
    ]);
    const reviews = reviewRes.items.map(r => ({ ...r, _type: 'review' }));
    const tmpls = tmplRes.items.map(t => ({ ...t, _type: 'template' }));
    _historyCache = [...reviews, ...tmpls].sort((a, b) =>
      (b.created_at || '').localeCompare(a.created_at || '')
    );
    renderHistoryList();
  } catch (e) {
    listEl.innerHTML = `<div class="empty-state"><div class="emoji">âŒ</div>${e.message}</div>`;
  }
}

async function deleteReview(id, btn) {
  btn.disabled = true;
  try {
    await api('DELETE', `/api/reviews/${id}`);
    btn.closest('.history-card').remove();
    toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  } catch (e) {
    toast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
    btn.disabled = false;
  }
}

async function deleteTemplate(id, btn) {
  btn.disabled = true;
  try {
    await api('DELETE', `/api/templates/${id}`);
    btn.closest('.history-card').remove();
    toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  } catch (e) {
    toast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
    btn.disabled = false;
  }
}

function copyText(text) {
  navigator.clipboard.writeText(text).then(() => toast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“'));
}

// â•â• Settings â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSettings() {
  try {
    const clinic = await api('GET', '/api/clinic');
    document.getElementById('s-name').value = clinic.name || '';
    document.getElementById('s-specialty').value = clinic.specialty || 'ì¹˜ê³¼';
    document.getElementById('s-doctor').value = clinic.doctor_name || '';
    document.getElementById('s-tone').value = clinic.tone || 'formal';
    document.getElementById('s-phone').value = clinic.phone || '';
    document.getElementById('s-naver-map').value = clinic.naver_map_url || '';
    document.getElementById('s-instagram').value = clinic.instagram_url || '';
    document.getElementById('s-kakao-channel').value = clinic.kakao_channel || '';
    currentSpecialty = clinic.specialty || 'ì¹˜ê³¼';

    // Parse emphasis string â†’ list
    const emphStr = clinic.emphasis || '';
    emphasisList = emphStr ? emphStr.split(/,\s*/).filter(Boolean) : [];
    renderEmphasisChips();
    renderEmphasisTags();

    forbiddenWords = Array.isArray(clinic.forbidden_words) ? [...clinic.forbidden_words] : [];
    renderForbiddenTags();
  } catch {}
}

function onSpecialtyChange() {
  currentSpecialty = document.getElementById('s-specialty').value;
  renderEmphasisChips();
}

function renderEmphasisChips() {
  const opts = SPECIALTY_EMPHASIS[currentSpecialty] || SPECIALTY_EMPHASIS['ê¸°íƒ€'];
  const el = document.getElementById('emphasis-chips');
  el.innerHTML = opts.map(o => {
    const selected = emphasisList.includes(o) ? ' selected' : '';
    return `<div class="chip${selected}" onclick="toggleEmphasisChip(this, '${escapeHtml(o)}')">${escapeHtml(o)}</div>`;
  }).join('');
}

function toggleEmphasisChip(chipEl, value) {
  if (emphasisList.includes(value)) {
    emphasisList = emphasisList.filter(v => v !== value);
    chipEl.classList.remove('selected');
  } else {
    emphasisList.push(value);
    chipEl.classList.add('selected');
  }
  renderEmphasisTags();
}

function renderEmphasisTags() {
  const el = document.getElementById('emphasis-tags');
  el.innerHTML = emphasisList.map((w, i) =>
    `<div class="tag">${escapeHtml(w)}<button class="tag-remove" onclick="removeEmphasis(${i})">Ã—</button></div>`
  ).join('');
}

function addEmphasis() {
  const input = document.getElementById('s-emphasis-input');
  const word = input.value.trim();
  if (!word || emphasisList.includes(word)) { input.value = ''; return; }
  emphasisList.push(word);
  input.value = '';
  renderEmphasisTags();
  // Sync chips if it matches
  renderEmphasisChips();
}

function removeEmphasis(i) {
  emphasisList.splice(i, 1);
  renderEmphasisTags();
  renderEmphasisChips();
}

function addForbiddenChip(word) {
  if (!forbiddenWords.includes(word)) {
    forbiddenWords.push(word);
    renderForbiddenTags();
  }
}

function addForbiddenWord() {
  const input = document.getElementById('s-forbidden-input');
  const word = input.value.trim();
  if (!word || forbiddenWords.includes(word)) { input.value = ''; return; }
  forbiddenWords.push(word);
  input.value = '';
  renderForbiddenTags();
}

function removeForbiddenWord(i) {
  forbiddenWords.splice(i, 1);
  renderForbiddenTags();
}

function renderForbiddenTags() {
  const el = document.getElementById('forbidden-tags');
  el.innerHTML = forbiddenWords.map((w, i) =>
    `<div class="ftag">${escapeHtml(w)}<button class="ftag-remove" onclick="removeForbiddenWord(${i})">Ã—</button></div>`
  ).join('');
}

async function saveSettings() {
  const name = document.getElementById('s-name').value.trim();
  if (!name) { toast('ë³‘ì›ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const btnText = document.getElementById('settings-btn-text');
  btnText.textContent = 'ì €ì¥ ì¤‘...';
  try {
    const clinic = await api('PUT', '/api/clinic', {
      name,
      specialty: document.getElementById('s-specialty').value,
      doctor_name: document.getElementById('s-doctor').value.trim(),
      tone: document.getElementById('s-tone').value,
      forbidden_words: forbiddenWords,
      emphasis: emphasisList.join(', '),
      phone: document.getElementById('s-phone').value.trim(),
      naver_map_url: document.getElementById('s-naver-map').value.trim(),
      instagram_url: document.getElementById('s-instagram').value.trim(),
      kakao_channel: document.getElementById('s-kakao-channel').value.trim(),
    });
    updateClinicHeader(clinic);
    toast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
    setTimeout(() => showScreen('reply'), 800);
  } catch (e) {
    toast('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
  } finally {
    btnText.textContent = 'ì„¤ì • ì €ì¥';
  }
}

// â•â• Service Worker â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/static/sw.js').catch(() => {});
  });
}

// â•â• Init â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initTheme();
document.getElementById('login-pw').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
if (token) afterLogin();
</script>
</body>
</html>
